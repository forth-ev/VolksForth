 leer                         clv02feb88                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ Directory 13.5.87          ccclv8feb89                                          listbufs                       2          frei                          3-4       fehlerbehandlung-test          5-11 kw   fehlerbehandlung-funktioniert 12-19      fehlerbeh  6                  20-26       frei                         27         SKIP[ ]SKIP                   28          frei                         29-32      fehlerbeh. mit tabort"        33-37      fehler (err in quit..         38-44      backup ..R/W                  45-53       frei                         54-59      Terminal                      60                                                                                                                                                                                                                                                                                                                                                                                                                                  \ listbufs                    clv14mar88                                                                                   : listbufs    prev                         BEGIN @ dup WHILE \ liste                   cr dup u. dup 2+ @ 1+                    IF dup 2+ 2+ @   blk/drv /mod               u. ." :" u. THEN                      stop? UNTIL drop ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ fehlerbeh. test             clv24nov87                                          .( fehlerbeh EXITS FAILS ;THEN ) cr      .( 1.5 scr + 2 scr ueberdefinieren)                                               : repare ['] (error errorhandler !         [ ' quit   >body dup @ ]                 Literal Literal !                        [ ' abort" >body dup @ ]                 Literal Literal !                        [ ' error" >body 2+ @ >body dup @ ]      Literal Literal ! ;                    : old repare                               ['] repare >name 4 - (forget save quit ;                                                                                   1 5 +thru                                  6 +load \ beispiel                                                            ' throw errorhandler !                   ' nquit ' quit >body ! \ patch           ' n(abort" ' (abort" >body !             ' n(err" ' error" >body 2+ @ >body !     save quit                                                                        \ ep eClrS throw catch        clv19nov87                                          ( | ) User ep     0 ep !                 ( | ) User eClrS  eClrS on                                                        ( | ) : throw                             ep @ rp!  r> ep !  r>                    [ last @ name> >body ] Literal >r >r ;  \ rstack: ... throw catchAdr             \ ' throw errorhandler !                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       \ (error Abort" Error"        clv16nov87                                          : n(error  ( string -- )                  standardi/o                              space here .name count type space ?cr    blk @  ?dup IF  scr !  >in @  r# ! THEN  eClrS @ IF clearstack THEN quit ;                                                \\                                       : (abort"    "lit swap                    IF eClrS on  errorhandler perform exit      THEN  drop ;  restrict                                                        | : (err"    "lit swap                    IF eClrS off errorhandler perform exit      THEN drop ;    restrict                                                       : Abort"  compile (abort" ," ;            immediate  restrict                                                              : Error"  compile (err"   ," ;            immediate  restrict                                                                                                                                               \                             clv16nov87                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ FAILS                       clv16nov87                                          Create: unfails r> ep ! rdrop ;          Create: unexits r> ep ! ;                                                         : (fails ( --)                             r>  dup 2+ >r  ep @ >r  rp@ ep !             unfails >r                           dup @ + >r ; restrict                                                           : (exits ( --)                             r>  dup 2+ >r  ep @ >r  rp@ ep !             unexits >r                           dup @ + >r ; restrict                  \ branchtarget & catchpart  follows      \ rstack: ... adr oldep uncatch cont     \             ep ---^                                                             : FAILS  compile (fails  >mark -1 ;               immediate restrict              : EXITS  compile (exits  >mark -1 ;               immediate restrict              : ;THEN  compile exit [compile] THEN ;            immediate restrict                                                      \ quit                        clv16nov87 \ patches:                                                                        : n(abort" rdrop   "lit swap              IF eClrS on  errorhandler perform exit      THEN  drop ;  restrict                                                        | : n(err" rdrop   "lit swap              IF eClrS off errorhandler perform exit      THEN drop ;    restrict              : nquit    rdrop   r0 @ rp! [compile] [   FAILS n(error THEN 'quit ;               \ installs toplevel errorhandling                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \ fehlerbeh. beispiel         clv17nov87                                          : devon  ." device ist on  " ;           : devoff ." device ist off " ;                                                    : mistake? ." Fehler=y " key capital       Ascii Y = abort" aborted" ;                                                     : tf    ." t-1 " devon                     FAILS ." t-f " devoff ;THEN                    ." t-2 " mistake?                        ." t-3 " devoff ;                                                         : te    ." t-1 " devon                     EXITS ." t-f " devoff ;THEN                    ." t-2 " mistake? ." t-3 " ;                                                                                       : t cr ." mit FAILS:" tf cr tf cr            cr ." mit EXITS:" te cr te ;                                                                                                                                                                                                                     \ fehlerbeh. 2                clv07feb88                                          .( fehlerbeh EXITS #FAILS END ) cr       .( 4 scr + 1 scr ueberdefinieren)                                                                                            1 5 +thru                                6 7 +thru \ beispiel                                                            ' noop errorhandler !                    ' nquit ' quit >body ! \ patch           ' n(abort" ' (abort" >body !             ' n(err" ' error" >body 2+ @ >body !     save quit                                                                                                                                                                                                                                                                                                                                                                                                                 (c) clv 1988                                                                     \ pointer and rstack-handl.   clv07feb88                                          ( | ) User ep     \ error-return-pointer User err   err  off \ error-message      User eClr  eClr off \ error-clearstack                                                                                     Create: uncatch r> r> ep ! rp! ;                                                  ( |) Variable catchrp                                                             : <catch  r> rp@ catchrp ! >r ; restrict                                          : catch>  r> ep @ >r  rp@ ep !             catchrp @ >r uncatch >r >r ; restrict                                                                                                                                                                                                                                                                                                                                                                                                                           \ throw (exits (fails         clv07feb88                                          : throw rdrop err @ 0= ?exit               ep @ rp!  r> ep ! ; restrict                                                    : (exits   r>  dup 2+ >r <catch catch>     dup @ + >r ; restrict                                                           : (fails   r>  <catch dup 2+ >r catch>     dup @ + >r ; restrict                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ (#fails                     clv07feb88                                          : move>r ( from count--)        r> -rot    rp@ over - under rp! cmove       >r ;    restrict                               : r>move ( to count--)          r> -rot    under rp@ -rot cmove  rp@ + rp!  >r ;    restrict                                                                        create: getargs                           s0 @ r> - sp!   sp@ r@ 1+ 2* r>move ;                                            : (#fails ( ..args.. n--..args..)          >r r@ sp@ s0 @ swap -                    sp@ r> 2+ 2*                             ( .args. n depth from bytes)             r> <catch dup 2+ >r -rot move>r             nip nip getargs >r catch>             dup @ + >r ; restrict                                                                                                                                                                                                                                                                       \ FAILS EXITS #FAILS END      clv07feb88                                          : EXITS  compile (exits  >mark -1 ;               immediate restrict              : FAILS  [compile] BEGIN compile (fails           >mark -1 2swap ;                         immediate restrict              : #FAILS ( n--)                                   [compile] BEGIN compile (#fails          >mark -1 2swap ;                          immediate restrict             : END    dup 2 = IF 2drop THEN                    abs 1 ?pairs                             compile throw >resolve ;                 immediate restrict                                                                                                                                                                                                                                                                                                                                                                                                                                       \ (error (abort" quit         clv07feb88                                          : n(error  standardi/o space here .name   err @ count type space ?cr  err off      blk @  ?dup IF  scr !  >in @  r# ! THEN  eClr @ IF clearstack THEN quit ;                                                 : n(abort" rdrop   "lit swap              IF err !  eClr on                           errorhandler perform throw THEN       drop ;  restrict                                                                 | : n(err" rdrop   "lit swap              IF err !  eClr off                          errorhandler perform throw THEN       drop ;  restrict                                                                 : nquit    rdrop   r0 @ rp! [compile] [   FAILS n(error END 'quit ;                \ installs toplevel errorhandling                                                                                         \\ die RDROP sind nur wg. Patch                                                                                           \ fehlerbeh. beispiel         clv19nov87                                          : devon  ." device ist on  " ;           : devoff ." device ist off " ;                                                    : mistake? ." Fehler=y " key capital       Ascii Y = abort" aborted" ;                                                     : tf    ." t-1 " devon                     FAILS ." t-f " devoff END                      ." t-2 " mistake?                        ." t-3 " devoff ;                                                         : te    ." t-1 " devon                     EXITS ." t-f " devoff END                      ." t-2 " mistake? ." t-3 " ;                                                                                       : t cr ." mit FAILS:" tf cr tf cr            cr ." mit EXITS:" te cr te ;                                                                                                                                                                                                                     \ fhler test #FAILS           clv07feb88                                          \ Fuer Neugierige:                       : .rs r0 @ rp@                             DO cr I dup . ." :" @ dup .                 dup 2- @ uncatch 2- @ =                  IF ." -" 2- ELSE @ THEN >name .name      2 +LOOP ;                                                                                                             : .stack ." Stack:" .s ;                 : action ( n1 n2 n3--nSum)                 ." action:" .stack + + mistake? ;                                               : t#fails    1 2 3                         3 #FAILS  ." F:" .stack                            ." retry=y?" key Ascii y -               UNTIL END                      action ." successfull:"  .stack drop ;                                                                                                                                                                                                                                                      \ EH:LOADs exception handling clv24feb88                                          User ep           \ error-return-pointer User err  err off \ error-message                                                                                                                                     1 3 +thru \ throw EXITS #FAILS RETRY       4 +load \ patches (abort" (err" quit \ 5 7 +thru \ beispiel                                                                                                     save quit                                                                                                                                                           \\ (c) 1988 volksFORTH83-Autoren                in der Forth-Gesellschaft e.V.                                             enwickelt von Claus Vogt, 1988           unter ultraFORTH83 Vs 3.8 auf CBM +4                                              Thanks to Klaus Schleisiek and TLC-Lisp                                                                                   \ EH:returnstack  catch-throw clv24feb88                                          : <rstack r> rp@ >r >r ; restrict                                                 : ,r      ( u--)                           r> r> rot >r >r >r ; restrict                                                   : rmove   ( adr u --)                      r> r>  rp@ 3 pick - rp!                  rp@ -rot >r >r swap cmove ; restrict                                            Create: unstack  r> rp! ;                Create: uncatch  r> r> ep ! rp! ;        : rstack> r> unstack >r >r ; restrict                                             : catch>  r> r> ep @ >r rp@ ep ! >r                   uncatch >r >r ; restrict                                             : throw  err @                             IF ep @ rp!  r> ep ! ELSE rdrop THEN     ; restrict                                                                      : ?throw ( flag--)                         IF rdrop throw THEN ; restrict                                                 \ EH:(exits (fails (#fails    clv24feb88                                          : (exits \ frame to be executed after             \ error or exit                   r>  err @ IF err dup push off THEN       dup 2+  >r  <rstack catch>               dup @ + >r ; restrict                                                           : (fails \ frame executes after error      r>  <rstack  dup 2+ ,r  catch>           dup @ + >r ; restrict                                                           Create: getargs          \ restore:       s0 @ r> 2* - sp!        \ stack-pointer  sp@ rp@ swap  r@ 1+ 2*  cmove \ values   r> 2* rp@ + rp! ;       \ returnstack                                            : (#fails ( u*args u--u*args)              >r sp@ r> \ saves also arguments         r> <rstack  dup 2+ ,r                         -rot under 2* rmove ,r                   depth ,r  getargs ,r  catch>        dup @ + >r ; restrict                                                                                                   \ EH:FAILS EXITS #FAILS RETRY clv24feb88                                          : EXITS  compile (exits  >mark -1                 ; immediate restrict                                                     : FAILS  compile (fails  >mark -1                 ; immediate restrict                                                     : #FAILS ( n--)                                   compile (#fails >mark -1                 ; immediate restrict                                                     : RETRY  compile branch over 2- <resolve          [compile] THEN                           ; immediate restrict                                                     \\ use:                                                                           EXITS      ...        throw THEN  ...                                             (#)FAILS   ...   ?throw ... RETRY ...                                             don't use: IF ... ELSE ... RETRY  !!!!                                                                                    \ EH:(error (abort" quit      clv24feb88                                          ' noop errorhandler  !                                                            | : err! ( flag--) rdrop  "lit swap        IF dup err ! errorhandler perform drop      throw THEN  drop ;  restrict                                                 : n(abort" rdrop ( * ) err! ; restrict   ' n(abort"  ' (abort" >body  !                                                    : n(err"   rdrop ( * ) err! ; restrict   ' error" >body 2+ @  | Alias (err"       ' n(err"   ' (err"   >body  !                                                     : .err  space here .name                   err @  count type space ?cr ;          : nquit    rdrop ( * )  r0 @ rp!           FAILS  standardi/o .err                    blk @ ?dup IF scr !  >in @ r# ! THEN     err @ 2- @   ['] (err" -                 IF clearstack THEN                     RETRY  err off  [compile] [  'quit ;   ' nquit  ' quit >body  !                                                         \ EH:sample..                 clv24feb88                                          : devon   ." aktion begonnen "  cr ;     : devoff  ." aktion beendet "   cr ;                                                                                       : .ok     ." alles erfolgreich" cr ;     : .handle ." Ausnahmebehandlung: " ;     : .stack  ." Stack:" .s cr ;                                                      : ?y?  ( --flag)                           ." =y "  key capital Ascii Y =           dup 0= IF del del ." n " THEN cr ;                                              : ok?  ." Fehler?" ?y? abort" abbruch" ;                                          : retry? ( --flag) ." nochmal?" ?y? ;                                             : action ( n1 n2 n3--nSum)                 devon                                    .stack + +  ok?                          devoff ;                                                                                                                                                         \ EH:..sample                 clv24feb88                                          : tf    ."  t-1 " devon                    FAILS .handle   devoff   throw THEN            ."  t-2 " ok?                            ."  t-3 " devoff .ok ;                                                    : te    ."  t-1 " devon                    EXITS .handle   devoff   throw THEN            ."  t-2 " ok? .ok ;                                                       : t#       1111 2222 3333                  3 #FAILS  .handle .stack                           retry? 0= ?throw cr RETRY      action .ok .stack drop ;                                                                                                                                          : test  0 #FAILS cr cr ." alles" retry?                   0= ?throw cr RETRY          cr ." mit FAILS:"  cr tf cr              cr ." mit EXITS:"  cr te cr              cr ." mit #FAILS:" cr t# cr ;                                                                                         \ EH:ouput of returnstack     clv24feb88                                          \ Fuer Neugierige:                                                                : tab at? &22 umax at ;                                                           : ?.n ( adr string--)                      swap >name ?dup                          IF swap  count type  tab .name              rdrop exit THEN  drop ; restrict                                             : ?.name ( adr--)                          dup 2-    " pfa of"  ?.n                 dup 2- @  " "        ?.n                 dup 4 - @ " data of" ?.n                 tab ." ???" ;                                                                   : .rs r0 @ rp@  \ gibt rstack aus          DO cr I 6 u.r   I @ 6 u.r  space            I @ ?.name drop  2 +LOOP              cr ep @ 6 u.r ."  ep ! " ;                                                                                                                                                                                \ SKIP[ ]SKIP                 clv13feb88                                          : ]SKIP 4 ?pairs >resolve ] ;                                                     : SKIP[ reveal compile branch >mark 4      [compile] [ ;                            immediate restrict                                                                                                                                                \\                                                                                : t ." hier t"                                                                      SKIP[ : t2 ." hier t2 " ;                ]SKIP ." hier noch t" ;                                                                                                                                                                                                                                                                                                                                                                                                 leer                         clv02feb88                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         leer                         clv02feb88                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         leer                         clv02feb88                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         leer                         clv02feb88                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ fehlerbeh. 4                clv22feb88                                          \ mit tabort"                            \ nur Studie, da nicht patchbar          \ Beispiel wie gehabt                                                               1 3 +thru \ EXITS #FAILS END               4 +load \ systemaenderungen                                                   \\ Veraenderungen im System:                                                      errorhandler wird leider gestrichen      quit abort" (abort" error" (err" anders  (error wird in quit integriert                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \ pointer and rstack-handl.   clv22feb88                                          User ep   ep off \ Error-Ret-Ptr                                                  Create: uncatch r> r> ep ! rp! ;                                                  ( |) Variable catchrp                                                             : <catch  r>  rp@ catchrp !  0 >r  >r ;    restrict                                                                        : catch>  r> ep @ >r  rp@ ep !             catchrp @ >r uncatch >r >r ; restrict                                           : move>r ( from count--)        r> -rot    rp@ over - under rp! cmove       >r ;    restrict                                                                        : r>move ( to count--)          r> -rot    under rp@ -rot cmove  rp@ + rp!  >r ;    restrict                                                                                                                                                                                                  \ throw (exits (fails (#fails clv22feb88                                          | : rdo ( pfa--pfa)  r> swap 2+ >r >r ;  | : rskip  ( pfa--)  rdrop dup @ + >r ;                                           : (exits  rdo rskip ; restrict                                                    : EXITS  compile (exits  >mark -1 ;               immediate restrict                                                       : (fails                                   r> <catch rdo catch> rskip ; restrict                                           : (#fails ( ..args.. n--..args..)          >r r@ sp@ s0 @ swap -                    sp@ r> 2+ 2*                             ( .args. n depth from bytes)             r> <catch rdo -rot move>r                nip nip                                  EXITS s0 @ r> - sp!                            sp@ r@ 1+ 2* r>move exit THEN      catch> rskip ; restrict                                                                                                                                          \ FAILS #FAILS END      clv22fclv22feb88                                          : FAILS  [compile] BEGIN compile (fails           >mark -1 2swap ;                         immediate restrict              : #FAILS ( n--)                                   [compile] BEGIN compile (#fails          >mark -1 2swap ;                          immediate restrict             : END    dup 2 = IF 2drop THEN                    abs 1 ?pairs  >resolve ;                 immediate restrict                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \ (error (abort" quit         clv22feb88                                          : throw rdrop r> 2- \ points to tabort"    ep @ 2- rp!  r> 2- ! \ error-exit-pfa    r> ep ! ; restrict                                                              : (tabort" throw ; restrict              : (terr"   throw ; restrict                                                       : abort"  ( flag -- )                      [compile] IF   compile (tabort" ,"       [compile] THEN ; immediate  restrict   : error"  ( flag -- )                      [compile] IF   compile (terr"   ,"       [compile] THEN ; immediate  restrict                                            : quit    r0 @ rp! \ kann ev weg           FAILS standardi/o space here .name         r> dup 2+  count type space              dup ." at:" u.  ?cr                      blk @ ?dup IF scr !  >in @ r# ! THEN     ['] (tabort" = IF clearstack THEN        REPEAT THEN                            [compile] [ 'quit ;                                                            \ fehlerbeh. 5                clv23feb88                                          \ (errror in quit, User: ep / err                                                   1 3 +thru \ EXITS #FAILS END               4 +load \ patches (abort" (err" quit   5 6 +thru \ beispiel                                                            \\ ab hier wird gepatched:               : -!-  dup @ -rot , , , ;                Variable patches                         ' noop     errorhandler      -!-         ' nquit    ' quit >body      -!-         ' n(abort" ' (abort" >body   -!-         ' n(err"   ' error" >body 2+ @ >body -!- here patches !                                                                    : patch    patches @ patches 2+            DO  I 2 + @  I @  !   6 +LOOP ;        : unpatch  patches @ patches 2+            DO  I 4 + @  I @  !   6 +LOOP ;        \\ patch save quit                       \\ unpatch  ' ep >name 4 - (forget save     0 +load                                                                       \ pointer and rstack-handl.   clv23feb88                                          ( | ) User ep     \ error-return-pointer User err   err off \ points to message                                                                                     Create: uncatch r> r> ep ! rp! ;                                                  ( |) Variable catchrp                                                             : <catch  r> rp@ catchrp ! >r ; restrict                                          : catch>  r> ep @ >r  rp@ ep !             catchrp @ >r uncatch >r >r ; restrict                                           : move>r ( from count--)        r> -rot    rp@ over - under rp! cmove       >r ;    restrict                                                                        : r>move ( to count--)          r> -rot    under rp@ -rot cmove  rp@ + rp!  >r ;    restrict                                                                                                                                                         \ throw (exits (fails (#fails clv07feb88                                          : throw rdrop err @ 0= ?exit               ep @ rp!  r> ep ! ; restrict                                                    : (exits   r>  dup 2+ >r <catch catch>     dup @ + >r ; restrict                                                           : (fails   r>  <catch dup 2+ >r catch>     dup @ + >r ; restrict                                                           create: getargs                           s0 @ r> - sp!   sp@ r@ 1+ 2* r>move ;                                            : (#fails ( ..args.. n--..args..)          >r r@ sp@ s0 @ swap -                    sp@ r> 2+ 2*                             ( .args. n depth from bytes)             r> <catch dup 2+ >r -rot move>r             nip nip getargs >r catch>             dup @ + >r ; restrict                                                                                                                                                                                     \ FAILS EXITS #FAILS END      clv07feb88                                          : EXITS  compile (exits  >mark -1 ;               immediate restrict              : FAILS  [compile] BEGIN compile (fails           >mark -1 2swap ;                         immediate restrict              : #FAILS ( n--)                                   [compile] BEGIN compile (#fails          >mark -1 2swap ;                          immediate restrict             : END    dup 2 = IF 2drop THEN                    abs 1 ?pairs                             compile throw >resolve ;                 immediate restrict                                                                                                                                                                                                                                                                                                                                                                                                                                       \ (error (abort" quit         clv23feb88                                          | : err! ( flag--)                           rdrop ( deletes (ABORT" ) "lit swap      IF err !                                    errorhandler perform throw THEN       drop ;  restrict                                                              : n(abort" rdrop err! ; restrict         : n(err"   rdrop err! ; restrict                                                  : .err  space here .name                   err @  count type space                  ." AT:" err @ u.  ?cr ;                                                         : nquit    rdrop   r0 @ rp!                FAILS  standardi/o .err                    blk @ ?dup IF scr !  >in @ r# ! THEN     err @ 2- @   ['] (abort"  =              IF clearstack THEN                       REPEAT THEN                            err off  [compile] [  'quit ;                                                   \\ die RDROP sind nur wg. Patch                                                  \ fehlerbeh. beispiel         clv07feb88                                          : devon  ." device ist on  " ;           : devoff ." device ist off " ;                                                    : mistake? ." Fehler=y " key capital       Ascii Y = abort" aborted" ;                                                     : tf    ." t-1 " devon                     FAILS ." t-f " devoff END                      ." t-2 " mistake?                        ." t-3 " devoff ;                                                         : te    ." t-1 " devon                     EXITS ." t-f " devoff END                      ." t-2 " mistake? ." t-3 " ;                                                                                       : t cr ." mit FAILS:" tf cr tf cr            cr ." mit EXITS:" te cr te ;                                                                                                                                                                                                                     \ fhler test #FAILS           clv07feb88                                          \ Fuer Neugierige:                       : .rs r0 @ rp@                             DO cr I dup . ." :" @ dup .                 dup 2- @ uncatch 2- @ =                  IF ." -" 2- ELSE @ THEN >name .name      2 +LOOP ;                                                                                                             : .stack ." Stack:" .s ;                 : action ( n1 n2 n3--nSum)                 ." action:" .stack + + mistake? ;                                               : t#fails    1 2 3                         3 #FAILS  ." F:" .stack                            ." retry=y?" key Ascii y -               UNTIL END                      action ." successfull:"  .stack drop ;                                                                                                                                                                                                                                                      \ uniR/W                      clv15mar88                                          \ Zum Kopieren Disk/Tape                                                          \needs Code   .( ?!! Code !!?) quit      \needs s#>t+s (16 $46ee Alias s#>t+s C)  \needs 2@  : 2@  dup 2+ @ swap @ ;                                                  1 6 +thru \ diverse r/w's                7 8 +thru \ backup                                                              ' uniR/W  Is   r/w                       ' patch-sbufs ' save-buffers >body !                                              : uniIni supertape  r/wf on  virInit ;   uniIni                                   ' uniIni ' drvinit >body !                                                        save                                                                                                                                                                                                                                                                                          \ tapeR/W                     clv14mar88                                          : nofile ( f--) abort" nofile" ;         | Create blk.  ," blk."                  Variable r/wf  r/wf on                                                            \ greift auf interne Block-struktur!!!   \ blk $ffff  laedt naechsten block                                                : ?r/wf  ( rw/f--)  dup r/wf @ -         IF ." Press stop" key drop THEN r/wf ! ;                                          : tapeR/W  ( adr blk file r/wf -- flag)   swap nofile  dup ?r/wf                   IF swap dup 2- 2-  blk. count  bload        over 2- off \ no flags                   over - b/blk -                           abort" block-crash"                      over true = IF 2drop false exit THEN     2- 2- @ 2dup -                           IF ." not" u. ." ! " u.                     true exit THEN 2drop               ELSE drop dup 2- 2-  swap b/blk +             blk. count   bsave THEN false ;                                            \ blk# nofile ?dev            clv14mar88                                          \ : blk#   ( --blk) prev @ 2+ 2+ @ ;                                              $FFB1 >label LISTEN  $FF93 >label SECOND $FFAE >label UNLSN                       | Code (dev?                              sp x) lda                                $90 stx (16 $ae sta rom C) LISTEN jsr           \ wg. Fehler im Betr.syst.        $60 # lda  SECOND jsr  UNLSN jsr         0 # ldx  1 # ldy  (16 ram C)             $90 lda                                  sp x) sta  sp )y sta  Next jmp end-code                                          : dev?    ( dev -- flag)                  i/o lock  (dev? 0= i/o unlock ;                                                  \\                                       : ?device ( dev --)                        dev? ?exit                               buffers unlock                           true abort" no device" ;                                                                                                \ leer                        clv14mar88                                          \ simuliert mehrere Laufwerke auf Drv#0                                           Variable #drv                            Variable lastdrv                                                                  : virInit 4 0                             DO I 8 + dev? 0=                            IF I #drv ! leave THEN LOOP           lastdrv on ;                                                                     : virDrv   ( drv--)                        dup  1 #drv @ uwithin                    IF (drv ! exit THEN                      (drv off  lastdrv @ over -               IF cr ." Insert disk#" dup u.               lastdrv !  key THEN drop ;                                                   : virBlk   ( blk--blkOnDrv)                blk/drv /mod virDrv ;                                                                                                                                                                                     \ diskR/W                     clv14mar88                                          | $100 Constant b/sek                                                             : 1551r/w  ( adr blk file r/wf -- flag)   swap nofile  -rot  virBlk                diskopen  IF  drop nip exit  THEN        0 swap   2* 2* 4 bounds                  DO  drop  2dup I rot                         IF    s#>t+s readsector                  ELSE  s#>t+s writesector THEN            >r b/sek + r> dup  IF  LEAVE  THEN   LOOP   -rot  2drop  diskclose  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   \ dirR/W                      clv15mar88                                          \ Benutzt blk als Laufwerksnummer                                                 : dirR/W  ( adr blk file r/wf -- flag)    -rot nofile  virDrv  ( adr r/wf)         diskopen IF drop exit THEN               3 0  \ Directorie nur $300 lang !!       DO  ( adr r/wf) 2dup                         IF   &18 I  readsector                   ELSE &18 I  writesector THEN             IF 2drop false false leave THEN          swap b/sek + swap LOOP               drop 0= diskclose ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       \ uniR/W                      clv15mar88                                           4 Constant tape                         $f Constant dir                                                                   : info 2 pick IF ." r:" ELSE ." w:" THEN   2dup 3 u.r ." :" 3 u.r  10 spaces        cr $91 ( CurUp ) con! ;                                                         : uniR/W  ( adr blk file r/wf -- flag)    2 pick blk/drv /mod info                 dir case?                                IF tape case?      IF tapeR/W exit THEN     -rot  3 roll drop  dirR/W  exit THEN                                           tape case?                               IF $ff = IF rot drop true -rot THEN                            tapeR/W exit THEN  dup 4 u< IF drop drop 1551r/w exit THEN              drop drop ramR/W ;                                                                                                                                                                                                                      \ sort-buffers                clv15mar88                                          : du> ( d1 d2 --flag)                      rot 2dup -                               IF  u< nip nip exit THEN                 drop drop u> ;                         | : swap? ( adr--flag)                     @ dup 2+ @ -1 =                          IF drop false exit THEN                  dup 2+ 2@ rot @ 2+ 2@  du> ;           | : swapbufs ( adr--)                      dup @ dup @ dup @   >r swap r>           over ! over ! over ! drop ;                                                     : sort-buffers  prev                       BEGIN dup @ @ 0= IF drop exit THEN        dup swap?                                IF swapbufs prev ELSE @ THEN REPEAT ;                                          : patch-sbufs                              sort-buffers                             [ ' save-buffers >body @ , ] ;                                                                                                                                   \ backup                      clv14mar88                                                                                   : backup ( fromDrv toDrv--)                lastdrv on                               over dir  >drive                         over dir  >drive     copy                >r >r                                    0 r@  >drive                             blk/drv 1- r>  >drive                    0 r>  >drive         convey ;                                                                                            \\                                         Drv 0..3: reelle/virtuelle Disks         Drv 4   : tape-DEVICE                    Drv 15  : Directories                                                           \\                                       supertape  0 4 backup \ Disk-->Tape      supertape  4 0 backup \ Tape-->Disk                                               0 1 backup            \ Disk-->Disk                                                                                        leer                         clv14mar88                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         leer                         clv02feb88                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         leer                         clv02feb88                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         leer                         clv02feb88                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         leer                         clv02feb88                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         leer                         clv02feb88                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ TM:Terminal Loadscreen     cclv28feb89                                                                                                                                                                                                                  1 &11 +thru  \ serial interface            &12 +load  \ cbm ascii conversion        &13 +load  \ tx more than byte           &14 +load  \ dumb terminal                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               \ TM:Serielle Schnittstelle   clv28feb89                                                                                   | Variable INT \ location of interrupt                                            | $fd00 Constant Port@   \ 6551          | $fd10 Constant uport@  \ cts-port      | Variable ctrl                          | $314 Constant sint@                    | sint@ @ >Label oldSint                 | $fcbe >Label intEnd    \ system-depend                  \ interrupt end routine                                            Create Queue 0 , $80 allot                                                                                                                                        \\ 0      1     2         130 byte adr      len    out   128-byte-queue             len ::= number of characters queued      out ::= relative address of next                 output character                 (len+out)mod 128 = relative address                  of first byte empty                                                \ TM:Serielle Schnittstelle    clv8feb89                                          : tx  ( c -- )  port@ c! ;                                                        : tx? ( -- f )                              port@ 1+ c@  $10 and 0<>                 uport@ c@  $02 and 0<>                   and ;                                                                          \\                                                                                | Label no  0 # lda                      | Label pushaa  sp 2dec  sp )y sta          puta jmp  end-code                                                             Code tx? ( -- f )                           port@ 1+ lda  $10 # and  no beq \ ok?    uport@  lda  $02 # and  no beq \ cts? | Label yes $ff # lda  pushaa bne           end-code                                                                       Code tx  ( c -- )                           port@ sta  pop jmp  end-code                                                                                           \ TM:Serielle Schnittstelle   clv28feb89                                          : +dtr port@ 2+ dup c@   1 or  swap c! ;                                          : -dtr port@ 2+ dup c@ $fe and swap c! ;                                          : +rts port@ 2+ dup c@ $04 or  swap c! ;                                          : -rts port@ 2+ dup c@ $f3 and swap c! ;                                          \\                                                                                Code +dtr                                   port@ 2+ lda   $1 # or   port@ 2+ sta    next jmp  end-code                                                             Code -dtr                                   port@ 2+ lda  $fe # and  port@ 2+ sta    next jmp  end-code                                                                                                                                                                                                                                                                         \ TM:Serielle Schnittstelle    clv8feb89                                          | Label s-int                                port@ 1+ lda                             0>= ?[ oldSint jmp ]?                    $08 # and  0= ?[ intEnd jmp ]?           tya pha                                  queue lda  $68 # cmp                     0>= ?[ port@ 2+ lda  $f2 # and                  port@ 2+ sta ]? \ -dtr -rts       clc  queue 1+ adc                        $7f # and  tay  queue inc                port@ lda  queue 2+ ,y sta               pla tay  intEnd jmp  end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                          \ TM:Serielle Schnittstelle    clv8feb89                                          : rx? ( -- f ) queue c@ ;                Code sei  sei next jmp end-code          Code cli  cli next jmp end-code                                                   : rx  ( -- c )                              queue c@ 0=                              IF +dtr +rts  BEGIN queue c@ UNTIL          THEN                                  sei  queue dup  1+ c@  +  2+  c@         -1 queue +!  1 queue 1+ +!  cli ;                                              \\                                       Code rx?  ( -- f )                         queue lda  pushaa jmp  end-code                                                 Code rx   ( -- c )                         queue lda                                0= ?[ port@ 2+ lda  5 # or                     port@ 2+ sta        \ +dtr +rts          [[ queue lda  0<> ?] ]?            sei  queue 1+ ldy  queue 2+ ,y lda       queue dec  queue 1+ inc                  cli  push0a jmp  end-code             \ TM:Serielle Schnittstelle  clv228feb89                                          : s-init  s-int sint@ ! \ new interrupt     ctrl @ port@ 2+ !  +dtr +rts ;                                                 : bye  0 port@ 2+ c!  bye ;                \ -dtr -rts -rxint                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      \                            clv228feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \ TM: ctrl:                  clv228feb89                                          | : ctrl: ( adr 8b -- ) Create not c, ,       does> ( 8b -- )                                Create dup c@ c, 1+ @ , c,          does> dup c@  over 1+ @ c@ and                 over 3+ c@ or swap 1+ @ c! ;                                          \ The only meta-defining-word I ever saw                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \ TM: baudrate               clclv8feb89                                          | ctrl 1+ %00011111 ctrl: bd:                                                        $11 bd:    50baud                        $12 bd:    75baud                        $13 bd:   110baud                        $14 bd:   135baud                        $15 bd:   150baud                        $16 bd:   300baud                        $17 bd:   600baud                        $18 bd:  1200baud                        $19 bd:  1800baud                        $1a bd:  2400baud                        $1b bd:  3600baud                        $1c bd:  4800baud                        $1d bd:  7200baud                        $1e bd:  9600baud                        $1f bd: 19200baud                                                                                                                                                                                                                                                                          \ TM: bits stopbits          clv228feb89                                          | ctrl 1+ %01100000 ctrl: ln:                                                        $00 ln: 8bits                            $20 ln: 7bits                            $40 ln: 6bits                            $60 ln: 5bits                                                                  | ctrl 1+ %10000000 ctrl: st:                                                        $80 st: 1stop                            $00 st: xstop                                                                  \\ xStop gives: 8 bit+1 parity -> 1stop                  5 bit+0 parity -> 1.5                        other      -> 2stop                                                                                                                                                                                                                                                                                                                                         \ TM: parity                 clv228feb89                                          | ctrl    %11100000 ctrl: pa:                                                        $00 pa: noParity                         $80 pa: oddParity                        $c0 pa: evenParity                       $a0 pa: 1Parity                          $e0 pa: 0Parity                                                                | ctrl    %00010000 ctrl: ec:                                                        $10 ec: +echo \ only if -rts !!          $00 ec: -echo                                                                                                           \\ 1parity means:                            send and receive high parity             but no parity-check                                                                                                                                                                                                                                                                       \ TM: cbm>asc asc>cbm        cclv28feb89                                          : cbm>asc ( c -- c' )                       dup $41 $5b uwithin                      IF $20 + exit THEN                       dup $61 $7b uwithin                      IF $60 + exit THEN                       dup $c1 $db uwithin                      IF $7f and exit THEN                     $dc case? IF $7c exit THEN               $7c case? IF $dc exit THEN               $14 case? IF $08 exit THEN               $08 case? IF $14 exit THEN ;                                                   : asc>cbm ( c -- c' )                       dup $41 $5b uwithin                      IF $80 or exit THEN                      dup $61 $7b uwithin                      IF $20 - exit THEN                       dup $c1 $db uwithin                      IF $60 - exit THEN                       $dc case? IF $7c exit THEN               $7c case? IF $dc exit THEN               $14 case? IF $08 exit THEN               $08 case? IF $14 exit THEN ;         \ TM: txType txblocks         clv28feb89                                          $1a Constant #EOF                                                                 | : ?break key? abort" ***aborted***" ;                                                                                    | : ?tx ( c -- )                              BEGIN ?break tx? UNTIL                   cbm>asc #EOF case? IF $ff THEN tx ;                                          : txType ( adr count -- )                   bounds DO I c@ ?tx LOOP ;                                                      : txblocks ( fromBlk toBlk -- )             2dup u> abort" nein!"  s-init            1+ swap DO I block b/blk txType LOOP     #EOF ?tx ;                                                                     : txDisk 0 $a9 txBlocks ;                                                                                                                                                                                                                            \ TM: dumb Terminal          clclv8feb89                                          \ Sample for an easy Terminal                                                     \needs #LF     $0a Constant #LF                                                   | : ?rx  pause rx? 0= ?exit rx asc>cbm         #LF case?  IF cr exit THEN               #CR case?  IF row 0 at exit THEN         #BS case?  IF del exit THEN emit ;                                                                                   | : ?tx ( c --)                               cbm>asc BEGIN ?rx tx? UNTIL tx ;                                               300baud noparity 1stop 8bits -echo                                                : dumb s-init                               BEGIN BEGIN ?rx key? UNTIL                 key $1b case? IF -dtr exit THEN              #cr case? IF #CR ?tx #LF THEN        ?tx REPEAT ;                                                                                                                                                                               clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      clv20may87                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \\ zu fehlerbeh.              clv16nov87                                          ziel:                                    CATCH           (catch ---+              ...             ...       !              TO              branch -- ! ---+                         uncatch <-+    !         ...             ...            !         ENDCATCH        throw          !                         uncatch <------+                                                                                                                                    ONERROR         (catch ----+                             branch --- ! --+                         uncatch <--+   !         ...             ...            !         ENDONERROR      throw   <------+         ...             ...                                     ( ; macht uncatch )                                                                                                                                                                                                                   \\ zu fehler                  clv16nov87                                          TRY <#>         put#                                     (catch --                <word>          <word>                                   branch --                                uncatch                  ...             ...                      RETRY           get                                      branch --                                unstack                                  uncatch                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( .status push load           clv20may87                                                                                   Defer .status    ' noop Is .status                                                | Create pull  0  ] r> r> ! ;                                                     : push ( addr -- )                        r> swap dup >r @ >r  pull >r >r  ;       restrict                                                                         : load   ( blk --)                        ?dup 0= ?exit blk push  blk !            >in push  >in off                        .status interpret ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
 (4112)    l@lxal{ b6 { { _   cbz.3>\                                                                                                                                                                                                 ultraFORl  l	 # 2+P# 3+PSPM$PG# 1-18l  l	 # *2-o$ hTRUEy+$ tFALSEy+  $ "-1[$ !0$ 1y+ $ 2y+ $ 3y+ $ 4y+ $ ON+[s$$ OFF+s$% CLITT8FPl	 WANDH11l  XORHqql! -3H8Hl! -NOTsl	 ! kNEGATE8" DNEGATEH8Hl	 
$  `" D+ H&H'$%l	 # 1+\\ zu ONERROR                 clv16nov87                                          : ONERROR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \\ zu FAILS                   clv16nov87                                          --Quelltext-- --Compilat-----                                                     FAILS         catch ## -----!            <errorWords>  <errorWords>  !            ;THEN         exit          !            <continue>    <-------------!                                                     EXITS         catch ## -----!            <errorWords>  <errorWords>  !            ;THEN         exit          !            <continue>    <-------------!                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       \ test                        clv22may87                                          : getbufs \ [from to] --                  1+ swap ?DO I dup . block drop LOOP ;                                            4a 4a getbufs                            40 46 getbufs                            20 2a getbufs                            50 59 getbufs                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           \\ zu fehlerbeh.2             clv07feb88                                          Ermoeglicht das Behandeln eines abort"   oder error" in einer der auesseren       Routinen.                                  Die Behandlung kann sich im einfachen  Fall auf das Abschliessen bestimmter     Prozesse (z.B. Schliessen von Geraeten)  beschraenken, kann aber ggf. auch        einen weiteren Versuch starten.                                                   Die Benutzung geschieht mittels          Kontrollstrukturen                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \\                            clv07feb88                                          to linked List on return-stack           adress of abort" - message               =true after abort" / =false after error" temporary                                                                                                                                                                                                                                                                                      \\                                       Mit:  ...<CATCH ..rstackmanipul.. CATCH> wird eine Sequenz auf den rstack gelegt, die im Fehlerfalle ausgefuehrt wird.     Im normalen Exitfall wird sie von        UNCATCH entfernt                                                                  rstack: ... oldep oldrp uncatch-pfa -->                 ^                         ep @ points to ^                         oldep is old value of ep                 oldrp is rstack-Pointer before <CATCH                                            \\ zu throw (exits (fails     clv07feb88                                          THROW wirkt im Normalfall wie EXIT.        wenn sich das System nach ABORT" oder    ERROR" im Fehlerbehandlungszustand       befindet, aktiviert es die               naechst-aussere                          Fehlerbehandlungsroutine               (EXITS wird von EXITS compiliert.          Es installiert bei Ausfuehrung die       ihm folgende Sequenz als Fehler- und     Exit-Routine und branched ueber sie      hinweg. Der Returnstack nach (EXITS:     ... exit-pfa oldep oldrp uncatch-pfa            ^             /                          ^<<<<<<<<<<<<</                 (FAILS wird von FAILS compiliert.          Es installiert bei Ausfuehrung die       ihm folgende Sequenz als Fehler-         Routine und branched ueber sie           hinweg. Der Returnstack nach (FAILS:     ... fails-pfa oldep oldrp uncatch-pfa      ^                  /                     ^<<<<<<<<<<<<<<<<<</                                                         \\ zu (#fails                 clv07feb88                                                                                   (#FAILS ( ..args.. u--..args..)            wird von #FAILS compiliert.              Es installiert bei Ausfuehrung die       ihm folgende Sequenz als Fehler-         Routine und branched ueber sie           hinweg. Ausserdem sichert es             die u obersten Elemente und die Tiefe    des Datenstacks, sodass die Fehler-      Routine als oberste Elemente auf dem     Stack vorfindet: ( ..U*ARGS.. U)                                                  Der Returnstack nach (#FAILS:                                                     ... ..U*args.. U depth getargs-pfa         ^ fails-pfa oldep oldrp uncatch-pfa      ^                  /                     ^<<<<<<<<<<<<<<<<<</                                                                                                                                                                                                                             \\ zu Kontrollstrukturen      clv07feb88                                          \\ Benutzung:                            EXITS ... END \ ... bei exit und error   FAILS ... END \ ... bei error            #FAILS .. END \ ... bei error mit args                                            (#)FAILS .. WHILE .. WHILE .. REPEAT END ermoeglicht wiederholung                                                          Abschluss mit THEN geht auch, aber        Benutzerverantwortung!                                                           sinnlos: IF BEGIN END                                                             EXITS THEN macht zweimal das gleiche                                                                                                                                                                                                                                                                                                                                                                                     \ zu den patches              clv07feb88                                          Unterschiede zu Systemroutinen:          (ERROR ist nicht mehr ERRORHANDLER,        sondern wird von QUIT installiert.       Die Message wird in ERR uebergeben,      es fuehrt jetzt ggf. CLEARSTACK aus.   (ABORT" und (ERR" setzen Message           und ein Flag zum Thema Clearstack        und fuehren dann THROW aus.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \                             clv19nov87                                          \ rstack: ... oldrp oldep uncatch                                                 Create: uncatch r> ep! r> rp! ;          Create: catch ( ret oldrp --)             >r ep @ >r  rp@ ep !  uncatch >r >r ;                                            : (fails  ( --)                            r> rp@ over 2+ >r \ fails-ip             swap dup @ + swap catch ;              \ rstack: fails oldrp oldep uncatch                                               : (exits  ( --)                            rp@ r> dup 2+ >r  \ exits-ip             dup @ + swap catch ;                   \ rstack: exits oldrp oldep uncatch                                               : (#fails ( n--)                           r> rp@ over 2+ >r \ fails-ip             saveargs                                 swap dup @ + swap catch ;                                                                                                                                        \                             clv19nov87                                          Variable lastrp                          : <catch r> rp@ lastrp ! >r ;            : catch> r> lastrp @ >r                    ep @ >r rp@ ep ! uncatch >r >r ;                                                : (fails  ( --)                            r> <catch dup 2+ >r \ fails-ip           catch> dup @ + >r ;                    \ rstack: fails oldrp oldep uncatch                                               : (exits  ( --)                            <catch r> dup 2+ >r \ exits-ip           catch> dup @ + >r ;                    \ rstack: exits oldrp oldep uncatch                                               : (#fails ( n--)                           r> rp@ over 2+ >r \ fails-ip             saveargs                                 swap dup @ + swap catch ;                                                                                                                                                                                 \\ EH:the concept             clv24feb88                                          This level-(and sytem-!!)-dependant,     nestable exception-handler               is able to reconstruct stack-pointer and stack-datas.                                                                      It uses a structured syntax              opened by FAILS, #FAILS ( u--), EXITS    closed by THEN, RETRY                                                             The opening word installs the following  clause as errorhandler and continues     execution after the closing words.                                                If ABORT" or ERROR" is invoked during    this execution the installed errorclause is executed. It may RETRY execution or   THROW away execution to the surrounding  errorhandler, which may be for example   the top-level errorhandler installed by  QUIT.                                    It remains the possiblitity to install   a post-mortom-handler on lowest level.                                           \\ EH:returnstack catch-throw clv24feb88                                          r( --f)      begins frame                                                         r( f--u f)   adds word to frame                                                                                            r( f--u*Bytes f)  adds bytes at addr                                                                                                                                removes frame                            r( f--f unstack-pfa) ends frame                                                                                            r( f--f errorLink uncatch-pfa)                                                                                             continues execution at installed error-h andling-clause if ERR. Else like EXIT.   --------------------------------------    f     is the rstack-pointer above frame  ep    points to a linked list of               errorhandling-frames               frame means a data-block on retStack   \\ EH:(exits (fails (#fails   clv24feb88                                          RSTACK after execution of:                                                            (exits        (fails      (#fails        -----------   ---------   ---------      ...........   .........   .........      ...........   .........   .... <--+      ...........   .........   arg1    ^      ...rstack..   ..rstack.   arg2    ^      ...before..   ..before.    ..     ^      ...(exits..   ..(fails.   argU    ^      ...........   .........   u       ^      ...........   .........   sDepth  ^      ...........   .... <--+   GETARGS ^      handle <--+   handle  ^   handle  ^      f  -->-->-+   f  -->--+   f  -->--+   +->oldEP         oldEP       oldEP-->    ^  UNCATCH       UNCATCH     UNCATCH     ^     !             !           !        ^     !             !           !        ^     V             V           V        ^                                                                                EP @                                    \\ EH:FAILS EXITS #FAILS RETRYclv24feb88                                          Syntax: : name clause1                                  beg  handle-clause end                   clause2 ;                                                          beg::= EXITS / FAILS / u #FAILS          end::= THEN  / RETRY                                                              handle-clause may contain THROW, ?THROW  or other words. It is invoked, if ABORT" or ERROR" is called during execution of  clause2.                                                                          compiles to:                                                                       (EXITS           +--> (FAILS / (#fails    ptr ->-+        ^     ptr ->-+           ...    !        ^     ...    !          THROW   !        ^    ?THROW  !           ... <--+        ^     ...    !                           ^    BRANCH  !                           +--<- ptr    !                                 ... <--+                                                 \\ EH:patches for volksFORTH  clv24feb88                                          ERRORHANDLER called on low level. May     used to output post-mortem-information                                           (ABORT" and (ERR" must be patched.        Stores following string, performs        ERRORHANDLER and THROWs to outer level   error-clauses.                                                                   QUIT must be patched.                     Installs top-level errorhandler-clause,  which executes the same as the old       (ERROR-handler, which can be omitted.    It also demonstrates the (perhaps only)  use of .. FAILS ... RETRY ...                                                                                             ( * ) RDROPs with this mark are                necessary when patching words                                                                                                                                                                                                                  \\ EH:sample..                clv24feb88                                          DEVON is an example for an action,        which must be closed by another: DEVOFF  Used to demonstrate EXITS and FAILS                                              .OK .HANDLE .STACK prints silly texts                                                                                                                               ?Y? prompts for Yes/No and displays       the answer                                                                                                                OK? is an example for any action, that    may cause an error. It asks the User     to produce an error or not.                                                      ACTION is an example for any action       which consumes some arguments and        may cause an error.                      Used to demonstrate #FAILS                                                                                                                                        \\ EH:..sample                clv24feb88                                          TF demonstrates how to use                    FAILS ... THEN                       to close an action if an error occures                                                                                    TE demonstrates how to use                  EXITS ... THEN   for the same purpose                                                                                   T# demonstrates how to use                  u #FAILS ... ?throw ... THEN           to save stack-pointer and arguments, so  that the error-causing action may be     RETRYd after the handling clause         decided not to THROW up execution.                                               TEST puts TF, TE, T# in one word                                                                                                                                                                                                                                                              \\ EH:ouput of returnstack    clv24feb88                                                                                                                                                                                                              ?.N tries to output the name                 corresponding to adr witch comment       string and leaves if possible                                                                                          ?.NAME detects names of                      PFAs ( ie created bye CREATE:)           normal colon-definitions                 words like BRANCH and (DO with data      and nothing else                                                              .RS outputs adresses, contents               and perhaps right names on retStack      and the contents of EP which points      to a linked list of errorframes          placed on returnstack.                                                                                                                                         l  l	 # 2+P# 3+PSPM$PG# 1-18l  l	 # *2-o$ hTRUEy+$ tFALSEy+  $ "-1[$ !0$ 1y+ $ 2y+ $ 3y+ $ 4y+ $ ON+[s$$ OFF+s$% CLITT8FPl	 ll	 6 ^WATCH'+^^	V.z^_c$6 ^CONT+^^	z^$+5$:$+R5$+5$+R$w?1(4$7 ^S+^4F^(4* ?R^$7 ^N+^^(4u*G*	R^$7 	_L+^^	R^$8 '_D+s^(4s)
 F^(4"$%$H%%l	  -ROT+$ NIP+sh$ ,UNDER+s$ <PICK+$ nROLL+u	Oh$ 2SWAP+O$ 2DROP 2DUP+$  +AHl  ORHl  	% KLIT8Fl	 % GLITERAL+ b
  I $ R| $& 0<m$l & f0=P& \UWITHIN E$%
E&'lt' <$%%q0E$%lo' U<L$%E$%lql022]\Cll	 4 \TRACE'+md\V.]_c$4 {]BREAK+	d\]$4 ]TRACEL:+)I (l(d\#$4 ]+DOD]4 Q]-DOD] 4 ]+RD]4 ]-RD] 4 ]+PUSHD]4 ]-PUSHD] Z)^A^$^%$M^f\g\\Cl\$M^Pl \^^$l  !$%H$H$l +!%$%H$$H$l DROP} aSWAPu$$H $$l  lDUP8FHl  ?DUPPl	 l OVER8FHl	  ROT%t( E>+s$( 0>+k$( 0<>+q$( U>+sJ$( =+1$( -D0=+|$( ;D=+}a$( kD<+1b 22  J$+b sh$) \MIN+}) MAX+}) UMAX+J}) UMIN+#}) EXTEND+k$) ODABS+c\l Z)h\Z)* Os$2   NPUSH+O"1 \$+14!/~ $Mf\l Mg\Pf\b\c\ \1bT1[?m5R5(4u*G*Rw?1(4[5#1!1!121u/1!1!!\1R \8Fl  RDROP EXIT&l ?EXIT=(PVl	  3EXECUTEl  uPERFORM+_$ C@$% $l  C!$%H$l	  CTOGGLE+ds$ L@$%$Xb }$) ABS+Xb $+O	s$* (DO+1	* #(?DO+1b 	Oh$* 3BOUNDS+s$* xENDLOOPl+ (LOOP l	 l	 + (+LOOPq(Dl	 , I 
ER+zm[T$m _[DISPLAY+?dc$n [B/SCRy+ n [.LINE+9s55/?$n [.===+Rp) R=>$n [PRLIST+9h[R>$Screen Nr. =5R>?[R) [?h[???[$0 X[TOOLS,__zzZ)  Z)j\Nf\b\VOC-LINKV+ UDPV+ 
SP@$%$8F  l  SP!g l	  ?UP@_l' wUP!  l	  RP@l' RP!l >R8Fl} R>Q8Fl	  JR@8FHHHHl	 , JPR- BRANCH"$$l	 - ?BRANCHd(Kl. 8>MARK+ I $. \>RESOLVE+ 1s$. <MARK+ $. <RESOLVE+ 1I $. ?PAIRS+13unstructured$I hlh 8F l / CASE?  $AP	%QPlqlZ0 BIF+ b$0 DTHEN+{$0 -DELSE+  s{[$0 bEBEGIN+$0 _EWHILE+ b$+1b
 h{ $0 FREPEAT+  $0 EUNTIL+ b$1 DBDO+ TH-83 3.51 clv13.4.87*C16+*   	END-TRACEel	  7RECOVERZ)PFFl+ zNOOP	  ORIGINy+ S0V+ R0V+
 DPV+ OFFSETV+ BASEV+ OUTPUTV+ KINPUTV+ YERRORHANDLERV+ )$1 |C?DO+ :$1 DLOOP+  {$1 E+LOOP+  {$1 LEAVE+Om$2 :UM*^$%H&''&&&%&$''H&&%P$JP|'H&$%l	 3 vM*+kb skb
 Oq\Ob }$3 *!l4#$%=&QP&P'$PF%F$l"&(')&Q&P'$PF%F$(*$%P8&!H'!$H%*$(HF* $l	 b "SOURCE+!b 9 d$!!$b #WORD+#"$b #PARSE+#!2"sOQ!1O1!#$b #NAME R(h`'I (l()()&'&Plt&%&$%Pl	 $$%$h8)$$%) 
$h$$%$E(P%E)Pln )>NAME+b 1s)b "$ 2$+* R$n m*NAME>+*sR b $n *>BODY+	$n *.NAME+1$+ RR1b  1*'# $k (?HEADZ)  k )|+
);[
)$l )WARNINGZ)  +0);*'o,T-2b 4*'G*$exists >$l &)CREATE+ !I o,I V#R q3invalid name *' 4)
)b 
)#(I j(R '(  1b /ss $< J!SKIP+b 1b /ss $< !/STRING+E"1$h)Ia	I[``= ("CAPITAL" d"l	 > x"
CAPITALIZE"$%$&D&Pl	 H$ d"$l""*$ !&&!''8$!$%!%!\\ shadow zu 110              clv14may87                                          rdfirst=0 ==> nicht initialisiert                                                                                                                                   BasisadresLEARSTACKZ'Hl	 i K'HALLOT+1s	1u1X'$i 'HEAP+"$i %(HEAP?+,(]$+ 1',(s,(1*'#`'$8Fhl+O*'*$j 8(EDOES>+ (Rl|  ($+RR1+  $: W COMPILE+O	I $;  #TIBZ) ; !>TIBZ)!savesystem clv16may87                                                           ; !>INZ) ; !BLKZ)  ; !SPANZ) ; !TIB+!$; !QUERY+!RpF?!!!!$< !SCAN+b ' mit      false antwortet. Terminiert mit false,   wenn alle Bloecke durch sind und mit     <> false, wenn 'cfa' ein true zuruecklie fert                                                                                                                      %R%%&%%%%%b%o&R%N%%%% T$g }&NUMBER+&3?kb X$h 'LASTZ)  +*'$h #'HIDE+.'b mo,$h :'REVEAL+.'b
 mo,$h w'IRECURSIVE+`'$+.'b d|h$h '	IMMEDIATE+R@'$h 'RESTRICT+R'$i '
C	 7 MOVE+Jb O$O$8 PLACE+O$8  COUNT, $% 8Fl8 " ERASE+ $9 m FILL  $'
(HP)JP&(HJPl	 : _ HERE+$:  PAD+ Rb$:  ALLOT+#$:  ,+  $: E C,                                                                                                                                                                                                                                                                +b h$+b  hOb }hN%;h[$+R&b	 R
[$R$b	 R[$RHb	 R[$R%b [$$+R,1sR.1|$+N%[1;N%#$Z)  g H%NUMBER?+F1* &N%R R %R%%R-b [%R%%
&b F%R%%%	l 6 V/MOD+XO$6 /+2$6 MOD+h$6 */MOD+O$6  */+(2$6 6U/MOD+s%$6 eUD/MOD+%Os%O$7 yCMOVE D$P	F%l	 (&HP)'l7 CMOVE> %''%))%$(&PF'F)F%Pl                                                                                                                                                                                                                                                                d F$\NEEDS+V#.2b $$d W$HEX+RF$d $DECIMAL+R
F$e %DIGIT?+R01R	#b R1R	#b F#;h$e %
ACCUMULATE+ssF\hF\O$e [%CONVERT+* %%b % /$+&$+* [&#$+/* $f %DPLZ)+\h$3 2*
*l	 +[3division overflow$4 UM/MOD')(%$H'H&*8%)$(&*$%&'&&&%&$JP$%  $&H%H$'l 5 M/MOD+kb ds%kb b ss/$5 2/
SER+)+| (8FHl	  p C+ALIAS+)*'R b    R '*$q +VPZ) --]m-    q ,,CURRENTZ)-q e,CONTEXT+1,	$+1,	_,$q u,ALSO+1,R
~3Vocabulary stack full_,1,#_,$q ,TOSS+1,#+C3#}"$$c O#STATEZ)  c #eASCII+C3##b &$c #,"+R"#   $c $"LIT+OOd* $c ,$("+3$$c g$A"+ l$$$d t$(."+3$* ?$d $B."+ $$$d $a(+R)#$d $b.(+R)#?$d $a\+!55!$d $b\\+ d!$b @(b $|* R?  $???4$o *:+)a'o,_,)0(8Fl	 o *A;+ $0`'$o 0+CONSTANT+)I (8FHl	 o f+VARIABLE+) $p +UALLOT+R#3Userarea fulls#$p +U                                                                                                                                                                                                                                                                                              clv22feb88                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      clv22feb88                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \\ shadow zu 116              clv14may87                                          Uebertraegt den Block mit Nummer 'blk'   in den Bereich ab ['toadr'. Falls        Block nicht vorhanden: leeren Block      uebertragen. Falls Laenge des            uebertragenen Blocks > 1024 ist der      Blockmechanismus " damaged".                                                                                               Uebertraegt den Block der Nummer 'blk'   nach ['fromadr' in die Ramdisk. Er       wird falls bereits vorhanden erst        geloescht.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               clv23feb88                                                                                                                                                                                                                                                                                                                                                                                                                           create: getargs                           s0 @ r> - sp!   sp@ r@ 1+ 2* r>move ;                                            : (#fails ( ..args.. n--..args..)          >r r@ sp@ s0 @ swap -                    sp@ r> 2+ 2*                             ( .args. n depth from bytes)             r> <catch dup 2+ >r -rot move>r             nip nip getargs >r catch>             dup @ + >r ; restrict                                                                                                                                                                                     \\ shadow rdboot              clv14may87 weitere Versuche: 2e/f                   loescht die RamDisk, wenn vorhanden.                                                                                                                                                                         Fuehrt beim Booten (1.Kaltstart) aus:                                             : rdboot limit $c000 u>                   IF $c000 $533 !                          ELSE limit rdfirst ! $fd00 rdlimit !         rdnew 'rdboot THEN ;                                                                                                                                                                                                                             versetzt das System in einen Vor-Boot-   Zustand, wie er von SAVESYSTEM gebraucht wird                                                                                                                                                                                                        \\ shadow zu 119              clv14may87                                          Druckt die wichtigsten                   Ramdisk-Zeiger aus und prueft sie auf    Konsistenz. Muss ggf. angepasst werden.  - rdfirst = off: " not initialized"                                               - Pointer drucken                        -      "                                 -      "                                 - Pointer gegeneinander pruefen                                                   ..         " pointer error"              - Ramdisk-Bereich oberhalt von limit??   .. sonst   " limit too big"                                                                                                - aktuelles R/W drucken                                                           .. wenn oberhalb 'here' " forgotten"                                                                                                                                                                                                                 \\ shadow zu 11a              clv14may87                                                                                   Testet einen Block auf Konsistenz           druckt Block-Nummer                      druckt Block-Basisadresse                druckt Laenge                                                                                                                                                     Expandiert Testweise                                                                                                                                                   druckt die ersten Zeichen des Block      druckt expandierte Laenge.               Ist sie " too big" ?                                                          Falls der Block zu lang expandiert,      wuerde er beim Lesen den                 Block-Mechanismus zerstoeren. In diesem  Fall die Laenge ' n Basisadresse ! '     korrigieren oder den Block und alle      folgenden aus der RamDisk loeschen mit:  ' basisadresse rdafter ! '              \\ shadow zu 11b              clv14may87                                          Prueft die Konsistenz der Ramdisk        und druckt alle zentralen Daten aus.                                              Es aendert nichts. Dies muss der         Benutzer anschliessend tun.                                                       Zur Uebersicht:                              limit error == limit   > rdfirst       pointer error == rdfirst > rdafter                   oder rdafter > rdlast      forgotten error == R/W-Zeiger falsch           len error == Block zu lang               end error == EndeDesLezten Blocks                             > rdafter                                                                                                                                                                                                                                                                                                                                                                                     \\ shadow zu 11c              clv14may87                                                                                                                                                                                                                                                                                                keine ramdisk=>abort   / namen wird ..   .. dem Betriebssystem uebergeben         .. Geraet setzen (Supertape)             .. Endadr+1                              .. Anfangsadr                            .. binaer sichern                                                                                                                                                                                                                                                                                                                                                                beim ersten cold wird ramdisk geladen    und screen 100 ausgefuehrt.                                                      \ shadow zu rdboot-test       clv14may87                                          Funktionen:                              - loeschen einer vorhandenen Ramdisk     - Erzeugen einer neuen (limit pruefen)   - & loadDown                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       SER+)+| (8FHl	  p C+ALIAS+)*'R b    R '*$q +VPZ)                q ,,CURRENTZ)  q e,CONTEXT+1,	$+1,	_,$q u,ALSO+1,R
~3Vocabulary stack full_,1,#_,$q ,TOSS+1,#1b /ss $< J!SKIP+b 1b /ss $< !/STRING+E"1$h)Ia	I[``= ("CAPITAL" d"l	 > x"
CAPITALIZE"$%$&D&Pl	 H$ d"$l""*$ !&&!''8$!$%!%!b @(b $|* R?  $???4$o *:+)a'o,_,)0(8Fl	 o *A;+ $0`'$o 0+CONSTANT+)I (8FHl	 o f+VARIABLE+) $p +UALLOT+R#3Userarea fulls#$p +U+  $: W COMPILE+O	I $;  #TIBZ)  ; !>TIBZ)!                                                                                ; !>INZ)  ; !BLKZ)  ; !SPANZ)  ; !TIB+!$; !QUERY+!RpF?!!!!$< !SCAN+b                               clv15may87                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        LEARSTACKZ'Hl	 i K'HALLOT+1s	1u1X'$i 'HEAP+"$i %(HEAP?+,(]$+ 1',(s,(1*'#`'$8Fhl+O*'*$j 8(EDOES>+ (Rl|  ($+RR1+\h$3 2*
*l	 +[3division overflow$4 UM/MOD')(%$H'H&*8%)$(&*$%&'&&&%&$JP$%  $&H%H$'l 5 M/MOD+kb ds%kb b ss/$5 2/
%R%%&%%%%%b%o&R%N%%%% T$g }&NUMBER+&3?kb X$h 'LASTZ)  +*'$h #'HIDE+.'b mo,$h :'REVEAL+.'b
 mo,$h w'IRECURSIVE+`'$+.'b d|h$h '	IMMEDIATE+R@'$h 'RESTRICT+R'$i '
C sm 2$v .'+V#.3Haeh?$v R.I[COMPILE]+V.I $v .C[']+V.&$v  /NULLSTRING?+b 2$HH l	 w /
>INTERPRET0//x f/NOTFOUND]0/x y/NO.EXTENSIONS+~3Haeh?$x /	INTERPRET+s/+-1V#.b b _s/3compile on+b h$+b  hOb }hN%;h[$+R&b	 R
[$R$b	 R[$RHb	 R[$R%b [$$+R,1sR.1|$+N%[1;N%#$Z)  g H%NUMBER?+F1* &N%R R %R%%R-b [%R%%
&b F%R%%%6$ &&H''6(6) 6P() l&(*)+*(*)(Pl	  6P(*(*6(6((6)6l6+s	p$+677b 6R$6b
 h$OO77b 2 R?  ?KEY?? ?DECODE? ?EXPECT?   SEAL+-*$ K?$ONLY- ?%FORTH- ?%WORDS- ?$ALSO, @+DEFINITIONSz-+m1b$+6;*;I;$ ?'COLD]01i+ @@@'?\@>-$ultraFORTH-83  rev 3.5??a t@'RESTART]01i+ l5$Dr hd=55)& ?543955/U3??$ 5PAUSE	  5LOCK+]1b h$b 5 ]s$ 5UNLOCK+6$8 lHl /6FILEV+ 6PREVZ)  Z)   6B/BUFy+(Y" PHP`?CR+w?5R
1#b ?$+)| 	(l(T$ >OUTPUT:+))0(l(T$ V>EMITE>  >CRE> >TYPEE> 	?DELE> ?PAGEE>  ?ATE>
 ,?AT?E> 6?ROW+<?h$ a?COL+<?2$+)| 	(l($ q?INPUT:+))0(l($ ?KEYR0i4$ 4#S+4ab$ D4D.R+"d`4I4441(4?$ Y4.R+sX4$ 5U.R+s4$ 5D.+44$ (5.+X-5$ 95U.+-5$ g5.S+1R E: l5$ v5C/Ly+)  5L/Sy+  5LIST+3$Scr 3 =(FORGET+@(3	is symbol;=$ =FORGET+V.$J3	protectedu*@(b *  mm=$ H=EMPTY+$]=2$ >SAVE+ ]=mmmb] $ '>BYE+g:>Wc$+?1b [$ `>STOP?+?b >>$ >3$$` 3BLy+  ` 3	-TRAILINGW3 &%'$&I HP%h%lPF'F%lZ I3SPACE+C3>$ 4SPACES+: 4$+ m$ 4HOLD+[84#84$ b4<#+8484$ [4#>+84841$ 4SIGN+kb R-i4$ 4#+FR	b R-'l<(E,)-,$,$lH<,$-%l<l}+b 1<O $+]]1b( s b /   N$+<,)  "b
 -o,"b
 -o,$+<(=N<,(s1'*'$ ;CLEAR+ ]=$QUIT+02^ 2STANDARDI/O+*T$^ K2'ABORT]0^ 2ABORT+X'c2Y22_ 2SCRZ) _ 3R#Z)  _ 3(ERROR+Y24 G** ?4>!b 3!32_ %3(ABORT"+3$sb X'O$h$+3$sb $h$_ z3FABORT"+ 3$$_ 3FERROR"+ ~*;s6*;#$ ;ALL-BUFFERS+*;>;*;1b$+R $+*dJs@(|$+,(Ob^ 1O/Js	*Jb. @(bZ	;b 	;b 	*	  $<$ *H +$,$-,5,E*-+,E&!!1!1/$] 1+LOAD+!1$] O1THRU+s)
 1$] 1+THRU+s)
 W1$] 2c-->+!#!1$]  2RDEPTH+	1$] 82DEPTH+s1$+#b $
 compiling$$ ok$^ s2(QUIT+1?!/2 ^ 2'QUIT]02^ 2	[o:  O: o:9$ ?:COPY+}:$ :CONVEY+su1q3nein}:$ :LIMITy+  ;FIRSTZ)   ";ALLOTBUFFER+*;16	J;6*;#*;866$ 0;
FREEBUFFER+*;;61Jb( 9*;1b  
V.0*#b
  0I $$+[2R 3tight stack`'.'b @(b *  1=[3dictionary full$[ 0?STACK/18$HP	 Y0$EHl	  [3stack empty\ $1.STATUS]0Z)OO$\ 1PUSH+Os}1$\ 1LOAD+;!1R+99$ 9BLOCK+99$ 9UPDATE+R6"$ H9SAVE-BUFFERS+669b ,8 686$ 9EMPTY-BUFFERS+666b
 8 686$ :FLUSH+9:$+9y9b 6879b 9s9mmQ9$+9#JOb$ O: ly/;&b /s/+-1V#.b b _s/I s//;&b b s&&  /s/y /a[+/0u/#$y 0]+Q/0u/#$+[3Crash$z %0DEFER+)90I (hHl z i0(IS+O	$+/1ss/1|q3not deferred$z 0bIS+R"(8b $read 8 YO$+6b 	[1b66,8$+		O686$+6b "kb$+6b"k$ "8CORE?+i7$ q9(BUFFER+i7S88  9(BLOCK+i7S888 9hHl }9BUFFE202d@.02 3 @COLDG@@hh Xix  $! %$HP Xi  ! H
H  l	  @RESTARTaa@hhl@~ 5aC64KEY?xa]hl~ laGETKEYa> ?lZ aCURONaJHI 66  6(DISKERR+$error !  r to retry ?Rr1sRR1|q3aborted$ L7DISKERR]0W7 8R/W]0g+"kbj 	b3 1T1Y2"	u(8b $write 8 RVh$+	$+81T1Y2INDEX+h)! ?59R%?>b b$ hFINDEX+gb $h)1 ?5 PfgR%?O>|b bGg$ hINK-POTZ)    iC64INIT3i> ?> ?iii;@	xl,a 'i(BSAVEi> X?
 (2064)    lG8la9l{ b. { { b   F;:.+a                                                                                                                                                                                                 $volksFOR ed5;f$ ?gDISKOPEN+dRteR#Ced;f$ g	DISKCLOSE+dRed$ g1541R/W+s3no file"cc#b =5$beyond capacity2$gb h2$s). hb
 Pfg  PfmgfOb b"Gg$+REsREb ss$ VgTH-83 3.51 c64 clv9.4.87       	END-TRACEe	l	  7	RECOVERZ!PFFl# z	NOOP	  	ORIGINy# 	S0V# 	R0V#
 	DPV# 	OFFSETV# 	BASEV# 	OUTPUTV# K	INPUTV# Y	ERRORHANDLERV# b f1RR$fJb f1RR$f1RR$+fs$+F1%`4I4hR,i4I44$y+  1f
READSECTOR+dR>el$u1:13,0,* eZfed5;f;dReffd$ fWRITESECTOR+dR>el$b-p:13,0* eddR>efeddR>el$u2:13,0,* eZf	VOC-LINKV# 	UDPV# 

SP@
$%$8F  l  
SP!g
 l	  ?
UP@_
l'
 w
UP!
  l	  
RP@
l'
 
RP!
l
 
>R
8Fl}
 
R>Q
8Fl	  J
R@$	`> ?&l,a eBUSIN+d6e$ eBUS!Ee> ?l eBUSTYPE+: Ce5$ UeBUS@ f> ?lZ eBUSINPUT+: e5$ fDERROR?+dReeR01b >ea1b?d$y+y+y+v+fJb	 R$fJ	
8Fl  
RDROP
 EXIT&l
 ?EXIT=(PVl	  3EXECUTEl  uPERFORM#_$ C@$% $l  C!$%H$l	  CTOGGLE#ds$ L@$%$$  d686[3	no device> ?`> ?> ?ld`d dld d?DEVICE+d6d$e & d&> ?$	`> ?&l,a dBUSOUT+d6e$ 5eBUSOPEN+R|>e$ jeBUSCLOSE+R|>ed${e & d&> ?$l  !$%H$H$l +!%$%H$$H$l DROP}
 aSWAPu$$H $$l  lDUP8FHl  ?DUPPl	 l OVER8FHl	  ROT%  D$& b.> l?Hlclb cDISPLAY>bbcc(c;c^cYc>lr cB/BLKy+  cBLK/DRVy+ Z)  +cR$ cDRIVE+c$ d>DRIVE+c1$ &dDRV?+c$ adDRVINIT+$ xdI/OZ)   dBUSOFFd> L?  d86$%$H%%l	  -ROT#$ NIP#sh$ ,UNDER#s$ <PICK#
$ nROLL#
u
	O
h$ 2SWAP#
O
$ 2DROP 2DUP#$  +AHl
  ORHl
  
KO 5$II `II`` b
PRINTABLE?Ib bJlP bC64EMITb b.lb WbC64CR+ab$ bC64DEL+Rb4Rb$ cC64PAGE+Rb$ cC64AT=c &$> ?l,a 3cC64AT?`c8F8> ?((h lZ ucC64TYPEcWANDH11l
  XORHqql
! -3H8Hl
! -NOTsl	 ! kNEGATE8" DNEGATEH8Hl	 
$  `" D+ H&H'$%l	 # 1+l	  aCUROFFal	  aC64KEY+a5vabaa$ a#BSy+  Ua#CRy+  a	C64DECODE+ab b ?/$ab
 !$sO>$ a	C64EXPECT+!!Jb
 ?? 4$ 5bKEYBOARD?Aavaaab bCON!b> l? yPUTAy+ { jWy+ { jSETUPy+{ jNEXTy+	 { jXYNEXTy+,a{ jPOPTWOy+{ HjPOPy+}PfgR%?O>|b bGg$ hINK-POTZ)    iC64INIT3i> ?> ?iii;@	xl,a 'i(BSAVEi> X?l  l	 # 2+P# 3+PSPM$PG# 1-18l  l	 # *2-o$ hTRUEy#$ tFALSEy#  $ "-1[$ !0$ 1y# $ 2y# $ 3y# $ 4y# $ ON#[s$$ OFF#s$% CLITT8FPl	  lPlP i(BLOADi > U?li>hhh  l?@8> ;;i  ?` iFORTH-83+${  j	ASSEMBLER,  Wj-{   PUSHAy+P{ 'jPUSH0Ay+Z{ 5jPUSHy+{ djRPy+ { qjUPy+ { \jSPy+ { jIPy+ { jNy+$ { }jl 6 V/MOD#
XO
$6 /#2$6 MOD#h$6 */MOD#
O
$6  */#(2$6 6U/MOD#s%$6 eUD/MOD#

%O
s
%O
$7 yCMOVE D$P	F%l	 (&HP)'l7 CMOVE> %''%))%$(&PF'F)F%PlLEARSTACKZHl	 i KHALLOT#	1s
	1	u1X	$i HEAP#	"$i % HEAP?#, ]
$#1, s, 1*#`$8Fhl#O
*"$j 8 EDOES># Rl| $#RR1 #\h$3 2*
*l	 #[+division overflow$4 UM/MOD')(%$H'H&*8%)$(&*$%&'&&&%&$JP$% 	 $&H%H$'l 5 M/MOD#
kb ds%
kb b s
s/$5 2/
R%boRN T$g }NUMBER#+?kb X$h LASTZ!  #*$h #HIDE#.b mo$$h :REVEAL#.b
 mo$$h wIRECURSIVE#`$#.b d|h$h 	IMMEDIATE#R@$h RESTRICT#R$i 
C)$1 |C?DO#:$1 DLOOP#{$1 E+LOOP#{$1 LEAVE#O
m
$2 :UM*^$%H&''&&&%&$''H&&%P$JP|'H&$%l	 3 vM*#k
b skb
 O
q
\O
b }$3 *#b h$#b  hO
b }hN;h[$#R&b	 R
[$R$b	 R[$RHb	 R[$R%b [$$#R,1sR.1|$#N[1;N#$Z!  g HNUMBER?#F	)*N
R R RR-b [
R
b F	R%F l / CASE?  $AP	%QPlqlZ0 BIF#b$0 DTHEN#{$0 -DELSE# s{[$0 bEBEGIN#$0 _EWHILE#b$#1b
 h{ $0 FREPEAT# $0 EUNTIL#b$1 DBDO#d F\NEEDS#V&2b $d WHEX#RF	$d DECIMAL#R
F	$e DIGIT?#R01R	#b R1R	#b F	#;h$e 
ACCUMULATE#s
sF	\hF	\O
$e [CONVERT#*%b  /$#$#*[#$#/*$f DPLZ!8FHHHHl	 , JPR- BRANCH"$$l	 - ?BRANCHd(Kl. 8>MARK#I$. \>RESOLVE#1s$. <MARK#$. <RESOLVE#1I$. ?PAIRS#1+unstructured$I hlh 8#C+}$$c OSTATEZ!  c eASCII#C+b &$c ,"#R"$c "LIT#O
O
d*

$c ,("#3$c gA"#l$d t(."#3*7$d B."#$d a(#R)$d b.(#R)7$d a\#--$d b\\#;$Xb }$) ABS#Xb $#O
	

s

$* (DO#1	* #(?DO#1b 	O

h$* 3BOUNDS#s$* xENDLOOPl
+ (LOOP l	 l	 + (+LOOPq(Dl	 , I 	l4$%=&QP&P'$PF%F$l&(')&Q&P'$PF%F$(*$%P8&H'$H%*$(HF* $l	 b SOURCE#b 1;$$b WORD#$b PARSE#
2sO
Q
1O
1#$b NAME
t( E>#s$( 0>#k$( 0<>#q$( U>#sJ$( =#1$( -D0=#|$( ;D=#}a$( kD<#1b 22  J$#b sh$) \MIN#}) MAX#}) UMAX#J}) UMIN##}) EXTEND#k$) ODABS#
1b /ss $< JSKIP#
b 
1b /ss $< /STRING#E"1$h)Ia	I[``= (CAPITAL dl	 > x
CAPITALIZE$%$&D&Pl	 H$ d$l*$ &&''8$$%%% KLIT8Fl	 % GLITERAL# b
 I$R|$& 0<m$l & f0=P& \UWITHIN E$%
E&'lt' <$%%q0E$%lo' U<L$%E$%lql#$: WCOMPILE#O
	
I$; #TIBZ!  ; >TIBZ!                                                                                ; >INZ!  ; BLKZ!  ; SPANZ!  ; TIB#$; QUERY#RpF7$< SCAN#
b 1$#RR1b 1*#$k  ?HEADZ!  k !|#
!;[
!$l !WARNINGZ!  #0!;*o$T%2b ,*G"exists 6$l &!CREATE#Io$IVR q+invalid name*4!
!b 
!# Ij R  	 	 7 MOVE#
Jb O
$O
$8 PLACE#
O
$8 COUNT,$% 8Fl8 "ERASE#$9 mFILL $'
(HP)JP&(HJPl	 : _HERE#	$: PAD#Rb$: ALLOT#	#$: ,#$: EC,
R"(0b read 0 YO
$#.b 	[1b..,0$#	

	
	O
.8.$#.b "kb$#.b"k$ "0CORE?#i/$ q1(BUFFER#i/S00  1(BLOCK#i/S000 1hHl }1BUFFE                               clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       clv8feb89                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        