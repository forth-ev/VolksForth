k





k





k





k






\  ###  Main Directory  ###  cclv05jan87 
                                         
Versions-Geschichte $02                  
(C16 (C64 )         $03                  
Relocate System     $04                  
Spezial-Assembler   $05                  
savesystem          $0E                  
Target-compiler     $10                  
free                $34                  
                                         
Gebrauchsanleitung  $56                  
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\                            cclv06dec88 
                                         
clv06dec88 - Gebrauchswanweisung besser  
                                         
clv/re apr-oct87                         
 Fuer rev 3.8 - C16/C64                  
 Scr 3,4,c,10,12,1b,2f                   
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
                              clv2:jul87 
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\ Relocating a system        clv2:jull87 
                                         
$9400         $0400                      
( stacklength rstacklength -)            
 empty hex                               
 over + origin +  origin 0A + ! \ r0     
 origin +  dup    origin   1+ ! \ task   
             6 -  origin  8 + ! \ s0     
 (16 $c000 ' limit >body ! C)            
 cold                                    
\\ symbolic map of system                
up@ origin - is stacklength              
r0 @ up@ -   is rstacklength             
                                         
disk-buffer  limit        first @        
rstack       r0 @         rp@            
                                         
user, warm   up@ udp @ +  up@            
(heap)       up@          heap           
stack        s0 @         sp@            
                                         
system       here         origin 0FE +   
user, cold   origin 0FE + origin         
screen       0800         0400           
page 0-3     0400         0000          
( Forth-6502 Assembler             WFR ) 
( Basis: Forth Dimensions VOL III No. 5) 
                                         
Onlyforth  Assembler also definitions    
                                         
1 8  +thru                               
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
( Forth-83 6502-Assembler              ) 
                                         
: end-code   context 2- @  context ! ;   
                                         
Create index                             
0909 , 1505 , 0115 , 8011 ,              
8009 , 1D0D , 8019 , 8080 ,              
0080 , 1404 , 8014 , 8080 ,              
8080 , 1C0C , 801C , 2C80 ,              
                                         
| Variable mode                          
                                         
: Mode:  ( n -)   Create c,              
  Does>  ( -)     c@ mode ! ;            
                                         
0   Mode: .A        1    Mode: #         
2 | Mode: mem       3    Mode: ,X        
4   Mode: ,Y        5    Mode: X)        
6   Mode: )Y       0F    Mode: )         
                                         
                                         
                                         
                                         
                                         
                                        
( Code generating primitives  27jun85we) 
                                         
Variable >codes                          
                                         
| Create nrc ] c, , c@ here allot ! c! [ 
                                         
: nonrelocate   nrc >codes ! ;           
                                         
nonrelocate                              
                                         
| : >exec Create c,                      
         Does> c@ >codes @ + @ execute ; 
                                         
|  0 >exec >c,       |  2 >exec >,       
|  4 >exec >c@       |  6 >exec >here    
|  8 >exec >allot    | 0A >exec >!       
| 0C >exec >c!                           
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
( upmode  cpu                          ) 
                                         
| : upmode ( addr0 f0 - addr1 f1)        
 IF mode @  8 or mode !   THEN           
 1 mode @  0F and ?dup IF                
 0 DO  dup +  LOOP THEN                  
 over 1+ @ and 0= ;                      
                                         
: cpu  ( 8b -)   Create  c,              
  Does>  ( -)    c@ >c, mem ;            
                                         
 00 cpu brk  18 cpu clc  D8 cpu cld      
 58 cpu cli  B8 cpu clv  CA cpu dex      
 88 cpu dey  E8 cpu inx  C8 cpu iny      
 EA cpu nop  48 cpu pha  08 cpu php      
 68 cpu pla  28 cpu plp  40 cpu rti      
 60 cpu rts  38 cpu sec  F8 cpu sed      
 78 cpu sei  AA cpu tax  A8 cpu tay      
 BA cpu tsx  8A cpu txa  9A cpu txs      
 98 cpu tya                              
                                         
                                         
                                         
                                         
                                        
( m/cpu                                ) 
                                         
: m/cpu  ( mode opcode -)  Create c, ,   
 Does>                                   
 dup 1+ @ 80 and IF 10 mode +! THEN      
 over FF00 and upmode upmode             
 IF mem true Abort" invalid" THEN        
 c@ mode @ index + c@ + >c, mode @ 7 and 
 IF mode @  0F and 7 <                   
  IF >c, ELSE >, THEN THEN mem ;         
                                         
 1C6E 60 m/cpu adc   1C6E 20 m/cpu and   
 1C6E C0 m/cpu cmp   1C6E 40 m/cpu eor   
 1C6E A0 m/cpu lda   1C6E 00 m/cpu ora   
 1C6E E0 m/cpu sbc   1C6C 80 m/cpu sta   
 0D0D 01 m/cpu asl   0C0C C1 m/cpu dec   
 0C0C E1 m/cpu inc   0D0D 41 m/cpu lsr   
 0D0D 21 m/cpu rol   0D0D 61 m/cpu ror   
 0414 81 m/cpu stx   0486 E0 m/cpu cpx   
 0486 C0 m/cpu cpy   1496 A2 m/cpu ldx   
 0C8E A0 m/cpu ldy   048C 80 m/cpu sty   
 0480 14 m/cpu jsr   8480 40 m/cpu jmp   
 0484 20 m/cpu bit                       
                                         
                                        
( Assembler conditionals               ) 
                                         
| : range?   ( branch -- branch )        
 dup abs  07F u> Abort" out of range " ; 
                                         
: [[  ( BEGIN)  >here ;                  
                                         
: ?]  ( UNTIL)  >c, >here 1+ -           
                range? >c, ;             
                                         
: ?[  ( IF)     >c,  >here 0 >c, ;       
                                         
: ?[[ ( WHILE)  ?[ swap ;                
                                         
: ]?  ( THEN)   >here over >c@           
                IF swap >!               
 ELSE over 1+ - range? swap >c! THEN ;   
                                         
: ][  ( ELSE)   >here 1+   1 jmp         
 swap >here over 1+ - range?  swap >c! ; 
                                         
: ]]  ( AGAIN)  jmp ;                    
                                         
: ]]? ( REPEAT) jmp ]? ;                 
                                        
( Assembler conditionals               ) 
                                         
90 Constant CS    B0 Constant CC         
D0 Constant 0=    F0 Constant 0<>        
10 Constant 0<    30 Constant 0>=        
50 Constant VS    70 Constant VC         
                                         
: not    20 [ Forth ] xor ;              
                                         
: beq    0<> ?] ;   : bmi   0>= ?] ;     
: bne    0=  ?] ;   : bpl   0<  ?] ;     
: bcc    CS  ?] ;   : bvc   VS  ?] ;     
: bcs    CC  ?] ;   : bvs   VC  ?] ;     
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\ 2/w/inc/dec c16 ram/rom..  cclv2:jul87 
                                         
: 2inc                                   
 dup lda  clc  2 # adc                   
 dup sta  CS ?[  swap 1+ inc  ]?  ;      
: 2dec                                   
 dup lda  sec  2 # sbc                   
 dup sta  CC ?[  swap 1+ dec  ]?  ;      
                                         
: winc                                   
 dup inc  0= ?[  swap 1+ inc  ]?  ;      
: wdec                                   
 dup lda  0= ?[  over 1+ dec  ]?  dec  ; 
                                         
: ;c:                                    
 recover jsr  end-code ]  0 last !  0 ;  
                                         
(16 \ C16+Makros fuer Bankswitch.        
: ram $ff3f sta ;   : rom $ff3e sta ;    
' Jsr Alias NormJsr   Defer Jsr          
                                         
: C16+Jsr dup 0c000 u>                   
 IF rom NormJsr ram ELSE NormJsr THEN ;  
' C16+Jsr Is Jsr  C)                     
                                        
( Assembler ;code Code Label  03feb85bp) 
                                         
Onlyforth                                
                                         
: Assembler                              
 Assembler   [ Assembler ] mem ;         
                                         
: ;Code                                  
 [compile] Does>  -3 allot               
 [compile] ;      -2 allot   Assembler ; 
immediate                                
                                         
: Code  Create here dup 2- ! Assembler ; 
                                         
: >label  ( adr -)                       
 here | Create  swap , 4 hallot          
        heap 1 and hallot   \ 6502-align 
        here 4 - heap  4  cmove          
        heap last @ count 01F and + !    
 dp !                                    
        Does>  ( - adr)   @  ;           
                                         
: Label                                  
 [ Assembler ]  >here >label Assembler ; 
                                        
\ cSave cLoad..               clv08aug87 
                                         
\needs Code   .( ?! Code ?!) \\          
Assembler                                
(16 \needs rom    .( ?! rom ?!) \\  C)   
                                         
Onlyforth                                
$FF90 >label setMsg   $90 >label status  
$FFBA >label setlfs $FFBD >label setNam  
$FFD8 >label BSAVE  $FFD5 >label BLOAD   
Label slPars                             
 setup jsr (16 rom C)                    
 $80 # lda setMsg jsr 0 # lda status sta 
 N lda sec 8 # sbc  (drv    sta          
       CC ?[ dex ]? (drv 1+ stx          
 N ldx     N  1+ ldy 1 #  lda setlfs jsr 
 N 4 + ldx N 5 + ldy N 2+ lda setnam jsr 
 N 6 + ldx N 7 + ldy                     
 rts end-code                            
                                         
Label slErr \ AR=Kernalfehler            
 CC ?[ 0 # lda ]? pha                    
 status lda $BF # and                    
 (16 ram C) push jmp end-code            
                                   -->  
\ savesystem                   02oct87re 
                                         
Onlyforth                                
                                         
Code cSave ( f t+1 Name Nlen dev--err)   
 5 # lda    SLPars jsr                   
 N 8 + # lda bsave jsr                   
 slErr jmp end-code                      
                                         
: savesystem \ -- Name muss folgen       
 \ Forth-Kernal a la boot:               
   scr push 1 scr ! r#  push 0 r# !      
 \ Editor  a la boot                     
   [ Editor ]                            
   stamp$ push stamp$ off                
   (pad   push (pad   off                
 \ nun geht's los                        
   save                                  
   origin $17 - here     0 parse         
   8 csave abort" Save-Error" ;          
                                         
                                         
                                         
                                         
                                        
\ Target compiler loadscr     clv14oct87 
\ Idea and first Implementation by ks/bp 
\ Implemented on 6502  by ks/bp          
\ ultraFORTH83-Version by bp/we          
                                         
Onlyforth hex                            
\needs (16   .( ?! (16 (64 ?! C) quit    
Assembler \needs nonrelocate 5 load      
Assembler nonrelocate                    
                                         
Variable Image      C000 Image !         
                                         
Vocabulary Ttools                        
Vocabulary Defining                      
                                         
                                         
 1 10 +thru   \ Target compiler          
11 13 +thru   \ Target Tools             
14 16 +thru   \ Redefinitions            
clear                                    
\ hex 17 20 +thru   \ predefinitions     
                                         
                                         
                                         
                                        
\ Target header pointers     bp27jun85we 
                                         
Variable tdp                             
: there  tdp @ ;                         
                                         
Variable displace                        
Variable ?thead       0 ?thead !         
Variable tlast        0 tlast !          
Variable glast'       0 glast' !         
Variable tdoes>                          
Variable >in:                            
Variable tvoc         0 tvoc !           
Variable tvoc-link    0 tvoc-link !      
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\ Image and byteorder        clv2:jull87 
                                         
Code romoff (64                          
 sei 034 # lda 01 sta C) Next jmp        
                                         
Code romon  (64                          
 036 # lda 01 sta cli C) Next jmp        
                                         
Code >byte   ( 16b - 8bl 8bh)            
 SP )Y lda pha txa SP )Y sta             
 SP 2dec txa                             
 SP )Y sta pla PutA jmp                  
                                         
Code byte>   ( 8bl 8bh - 16b)            
 SP X) lda pha SP 2inc pla SP )Y sta     
 Next jmp end-code                       
                                         
: >image    ( addr1 - addr2)             
 displace @  -  image @  + ;             
                                         
: >heap  ( from quan -)                  
 heap over - 1 and +      \ 6502-align   
 dup hallot heap swap cmove ;            
                                         
                                        
\ Ghost-creating             bp27jun85we 
                                         
0 | Constant <forw>  0 | Constant <res>  
                                         
| : Make.ghost  ( - cfa.ghost)           
 here State @                            
 IF   Context @                          
 ELSE Current                            
 THEN @ dup @ ,                          
 name  dup  c@ 1 01F uwithin             
            not abort" inval.Gname"      
       1 over +!  c@ 1+ allot            
 here 2 pick - -rot                      
 <forw> , 0 , 0 ,                        
 over 2+ c@ 1 and 1 xor >r               
 over r@ -  here over - >heap            
 heap r@ + swap !       Dp !             
 heap r> + +  ;                          
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\ ghost words                ks27jun85we 
                                         
: gfind  ( string - cfa tf / string ff)  
 dup >r  1 over +!  find  -1 r> +! ;     
                                         
: ghost   ( - cfa)                       
 >in @  name  gfind                      
  IF nip exit THEN                       
  drop >in ! Make.ghost ;                
                                         
: Word,  ghost  execute ;                
                                         
: gdoes>  ( cfa.ghost - cfa.does)        
 4 + dup @                               
  IF @ exit THEN                         
  here dup <forw> , 0 , 4 >heap          
  DP !  heap dup rot ! ;                 
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\ ghost utilities            ks27jun85we 
                                         
: g'   name gfind 0= abort" ?" ;         
                                         
: '.                                     
 g' dup @ <forw> case?                   
   IF ."  forw"                          
   ELSE <res> - abort" ??" ."  res" THEN 
  2+ dup @ 5 u.r                         
  2+ @ ?dup                              
   IF dup @ <forw> case?                 
    IF ."  fdef"                         
    ELSE <res> - abort"  ??" ."  rdef"   
    THEN                                 
    2+ @ 5 u.r THEN ;                    
                                         
                                         
' ' Alias h'                             
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\ .unresolved                bp27jun85we 
                                         
| : forward? ( cfa - cfa / exit&true)    
 dup @ <forw> =                          
 over 2+ @ and                           
 IF drop True rdrop exit THEN ;          
                                         
| : unresolved? ( addr - f)              
 2+ dup c@ 01F and over + c@ BL =        
 IF name> forward? 4 + @                 
    dup IF forward? THEN                 
 THEN drop  False ;                      
                                         
| : unresolved-words                     
 BEGIN @ ?dup WHILE dup unresolved?      
    IF dup  2+ .name ?cr THEN            
 REPEAT ;                                
                                         
: .unresolved                            
 voc-link @                              
 BEGIN dup 4 - unresolved-words          
 @ ?dup 0= UNTIL ;                       
                                         
                                         
                                        
\ Ext. vocs for t-compilat.  bp27jun85we 
                                         
: Vocabulary                             
Vocabulary 0 , here tvoc @ , tvoc ! ;    
                                         
Vocabulary Transient    0 tvoc !         
                                         
Only definitions Forth also              
                                         
: T Transient ;   immediate              
: H Forth     ;   immediate              
                                         
definitions                              
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\ Transient primitives       ks04jul85we 
                                         
Transient definitions                    
                                         
: c@    H >image romoff c@ romon ;       
                                         
: c!    H >image romoff c! romon ;       
                                         
: @     T dup c@ swap 1+ c@ byte> ;      
                                         
: !     >r  >byte r@ 1+ T c!  r> c! ;    
                                         
: cmove ( from.mem to.target quan -)     
    bounds ?DO                           
    dup H c@ I T c! H 1+ LOOP drop ;     
                                         
: here  there ;                          
                                         
: allot Tdp +! ;                         
                                         
: c,    T here c! 1 allot H ;            
                                         
: ,     T here !  2 allot H ;            
                                         
                                        
\ Transient primitives       bp27jun85we 
                                         
: ,"    Ascii " parse dup T c,           
        under there swap cmove allot H ; 
                                         
: fill  ( addr quan 8b -)                
        -rot bounds                      
        ?DO dup  I T c! H LOOP drop ;    
                                         
: erase  0  T fill ;                     
: blank  BL T fill ;                     
: here!  H tdp ! ;                       
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\ Resolving                  ks29jun85we 
                                         
Forth definitions                        
                                         
: resolve  ( cfa.ghost cfa.target -)     
 over dup @ <res> =                      
   IF space dup >name .name ." exists  " 
      2+ ! drop exit THEN                
 >r >r 2+ @ ?dup                         
 IF BEGIN dup T @ H                      
           2dup = abort" resolve loop"   
       r@ rot T ! H ?dup 0= UNTIL THEN   
 r> r>  <res> over !  2+ ! ;             
                                         
: resdoes>  ( cfa.ghost cfa.target -)    
 swap gdoes> dup @ <res> =               
 IF 2+ ! exit THEN swap resolve ;        
                                         
] Does> [ here 3 - 0 ]                   
        dup @ there  rot ! T , H ;       
  ' <forw> >body !                       
                                         
] Does> [ here 3 - 0 ]                   
        @ T , H ;                        
  ' <res>  >body !                      
\ move-threads  6502-align   clv24.3.87) 
                                         
: move-threads                           
 Tvoc @  Tvoc-link @                     
 BEGIN over ?dup WHILE 2- @  over 2- T ! 
       @ H  swap @ swap                  
 REPEAT                                  
 error" some undef. Target-Vocs left"    
 drop ;                                  
                                         
| : tlatest   ( - addr)                  
   Current @ 6 +  ;                      
                                         
| : 6502-talign  ( supposed cfa -- )     
 0FF and 0FF =  IF  1 T allot H  THEN ;  
                                         
: save-target   \ name muss folgen       
 08 02 busopen                           
 0 parse bustype " ,p,w" count bustype   
 busoff                                  
 08 02 busout                            
 displace @ 100 u/mod swap bus! bus!     
 there displace @                        
   DO I T c@ H bus! LOOP                 
 08 02 busclose ;                       
\ compiling names into targ. bp27jun85we 
                                         
: (theader                               
 ?thead @  IF 1 ?thead +!                
     there 6502-talign exit THEN         
 >in @ name swap >in !                   
 dup c@ 1 020 uwithin not                
                  abort" inval. Tname"   
 dup  c@ 5 +  there +  6502-talign       
 blk @  T , H                            
 there tlatest dup @  T , H !            
 there dup tlast !  over                 
 c@ 1+ dup  T allot cmove H  ;           
                                         
                                         
: Theader    tlast off                   
 (theader Ghost                          
 dup glast' ! there resolve ;            
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\ prebuild defining words    bp27jun85we 
                                         
| : executable?   ( adr - adr f)  dup ;  
                                         
| : tpfa,  there , ;                     
                                         
                                         
| : (prebuild   ( cfa.adr -)             
 >in @  Create  >in !  here 2- ! ;       
                                         
: prebuild   ( adr 0.from.: - 0)         
 0 ?pairs                                
 executable? dup >r                      
 IF [compile] Literal                    
     compile  (prebuild                  
 ELSE drop  THEN                         
 compile Theader  Ghost gdoes> ,         
 r>  IF compile tpfa, THEN 0 ;           
immediate restrict                       
                                         
                                         
                                         
                                         
                                         
                                        
\ code portion of def.words  bp27jun85we 
                                         
: dummy   0 ;                            
                                         
                                         
: Do>     ( - adr.of.jmp.dodoes> 0)      
          [compile] does>  here 3 -      
           compile  @   0  ]  ;          
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\ the 6502 Assembler         bp27jun85we 
                                         
| Create relocate                        
 ] T c, , c@ here allot ! c!   H [       
                                         
Transient definitions                    
                                         
: Assembler  H                           
 [ Assembler ] relocate >codes !         
 Assembler ;                             
                                         
: >label  ( 16b -) H                     
 >in @ name gfind  rot >in !             
  IF over resolve dup THEN               
 drop Constant   ;                       
                                         
: Label  H there T >label  Assembler H ; 
                                         
: Code  H                                
 Theader there 2+ T , Assembler H   ;    
                                         
                                         
                                         
                                         
                                        
\ immed. restr. ' | compile  bp27jun85we 
                                         
: ?pairs    ( n1 n2 -- ) H               
 - abort" unstructured" ;                
                                         
: >mark     ( - addr)  H there T 0 , H ; 
: >resolve  ( addr -)  H                 
            there over - swap  T ! H ;   
: <mark     ( - addr)  H there ;         
: <resolve  ( addr -)  H there - T , H ; 
                                         
: immediate   H Tlast @ ?dup             
 IF dup T c@  040 or swap c! H THEN ;    
                                         
: restrict    H Tlast @ ?dup             
 IF dup T c@  080 or swap c! H THEN ;    
                                         
: '   ( <name> - cfa)  H                 
 g' dup @ <res> -   abort" ?" 2+ @ ;     
                                         
: |  H ?thead @ ?exit ?thead on ;        
                                         
: compile  H Ghost , ;                   
 immediate  restrict                     
                                        
\ Target tools               ks27jun85we 
                                         
Onlyforth Ttools also definitions        
                                         
| : ttype   ( adr n -)                   
 bounds ?DO I T c@ H  emit LOOP ;        
                                         
: .name    ( nfa -)                      
 ?dup                                    
 IF dup 1+ swap T c@ H 01F and ttype     
 ELSE ." ??? " THEN  space ?cr ;         
                                         
| : nfa? ( cfa lfa - nfa / cfa ff)       
   BEGIN  dup WHILE  2dup 2+ dup         
            T c@ H 01F and + 1+ =        
             IF 2+ nip exit THEN         
            T @ H  REPEAT ;              
                                         
: >name  ( cfa - nfa / ff)               
 Tvoc BEGIN @ dup WHILE under 2- @ nfa?  
        ?dup IF nip exit THEN            
      swap  REPEAT  nip  ;               
                                         
                                         
                                        
\ Ttools for decompiling     ks29jun85we 
                                         
| : ?:  dup          4 u.r ." :"  ;      
| : @?  dup  T @  H  6 u.r  ;            
| : c?  dup  T c@ H  3  .r  ;            
                                         
: s  ( adr - adr+)                       
 ?: space  c?  3 spaces                  
 dup 1+ over T c@ H ttype dup            
 T c@ H + 1+ ;                           
                                         
: n  ( adr - adr+2)                      
 ?: @? 2 spaces dup                      
 T @ H [ Ttools ] >name .name H 2+ ;     
                                         
: d  ( adr n - adr+n)                    
 2dup swap ?: swap 0                     
   DO c? 1+ LOOP 2 spaces -rot ttype ;   
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\ Tools for decompiling      bp29jun85we 
                                         
: l  ( adr - adr+2)                      
 ?: 5 spaces @? 2+  ;                    
                                         
: c  ( adr - adr+1)   1 d ;              
                                         
: b  ( adr - adr+1)                      
 ?: @? dup T @ H over + 5 u.r 2+ ;       
                                         
: dump   ( adr n -)                      
 bounds ?DO cr I 8 d drop stop?          
   IF LEAVE THEN 8 +LOOP ;               
                                         
: view                                   
 T ' H  [ Ttools ] >name                 
 ?dup IF 4 - T @ H edit THEN ;           
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\ reinterpretation def.-words  27jun85we 
                                         
Onlyforth                                
                                         
: redefinition                           
 tdoes> @                                
 IF >in push                             
    [ ' >interpret >body ] Literal push  
   State push  Context push              
   >in: @ >in !                          
   name [ ' Transient 2+ ] Literal       
   (find nip 0=                          
   IF                                    
    cr ." Redefinition: " here .name     
   >in: @ >in ! : Defining interpret     
   THEN                                  
 THEN                                    
 0 tdoes> ! ;                            
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\ Create..does> structure    bp27jun85we 
                                         
| : (;tcode                              
 Tlast @ dup T c@ + 1+ !  H rdrop ;      
                                         
| : changecfa                            
 compile lit tdoes> @  ,                 
 compile (;tcode ;                       
                                         
Defining definitions                     
                                         
: ;code   0 ?pairs                       
 changecfa  reveal  rdrop  ;             
 immediate restrict                      
                                         
Defining  ' ;code  Alias  does>          
 immediate restrict                      
                                         
: ;   [compile] ; rdrop ;                
 immediate restrict                      
                                         
                                         
                                         
                                         
                                        
\ redefinition conditionals  bp27jun85we 
                                         
' DO    Alias  DO     immediate restrict 
' ?DO   Alias  ?DO    immediate restrict 
' LOOP  Alias  LOOP   immediate restrict 
' IF    Alias  IF     immediate restrict 
' THEN  Alias  THEN   immediate restrict 
' ELSE  Alias  ELSE   immediate restrict 
' BEGIN Alias  BEGIN  immediate restrict 
' UNTIL Alias  UNTIL  immediate restrict 
' WHILE Alias  WHILE  immediate restrict 
' REPEAT Alias  REPEAT                   
 immediate restrict                      
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\ clear Liter. Ascii ['] ."  bp27jun85we 
                                         
Onlyforth Transient definitions          
                                         
: clear  True abort" There are ghosts" ; 
                                         
: Literal  ( n -)  H dup $FF00 and       
 IF T compile lit ,                      
 ELSE compile clit c, H THEN ; immediate 
                                         
: Ascii  H BL word 1+ c@                 
 State @                                 
  IF T [compile]  Literal H THEN ;       
 immediate                               
                                         
: [']     T ' [compile] Literal H ;      
          immediate restrict             
                                         
: "       T compile ("   ," H  ;         
          immediate restrict             
                                         
: ."      T compile (."  ," H  ;         
          immediate restrict             
                                         
                                        
\ Target compilation  ]  [   bp03jul85we 
                                         
Forth definitions                        
                                         
: tcompile                               
 ?stack  >in @                           
 name find ?dup                          
 IF 0> IF nip execute   >interpret THEN  
    drop dup >in !  name THEN            
 gfind IF nip execute   >interpret THEN  
 nullstring? IF drop exit THEN           
 number? ?dup                            
  IF 0> IF swap T [compile] Literal THEN 
      [compile] Literal H drop           
      >interpret THEN                    
 drop >in ! Word,                        
 >interpret ; -2 allot                   
                                         
Transient definitions                    
                                         
: ]    H  State on                       
 ['] tcompile is >interpret ;            
                                         
                                         
                                        
\ Target conditionals        bp27jun85we 
                                         
: IF      T compile ?branch >mark H 1 ;  
          immediate restrict             
: THEN    abs 1 T ?pairs >resolve H ;    
          immediate restrict             
: ELSE    T 1 ?pairs compile branch      
          >mark swap >resolve H -1 ;     
          immediate restrict             
: BEGIN   T <mark H 2 ;                  
          immediate restrict             
: WHILE   T 2 ?pairs  2 compile ?branch  
          >mark -2  H 2swap ;            
          immediate restrict             
                                         
| : (repeat  T 2 ?pairs  <resolve H      
 BEGIN dup -2 = WHILE drop T >resolve H  
 REPEAT ;                                
                                         
: UNTIL   T compile ?branch (repeat H  ; 
          immediate restrict             
: REPEAT  T compile branch  (repeat H  ; 
          immediate restrict             
                                         
                                        
\ Target conditionals        bp27jun85we 
                                         
: DO     T compile (do  >mark H 3 ;      
         immediate restrict              
: ?DO    T compile (?do >mark H 3 ;      
         immediate restrict              
: LOOP   T 3 ?pairs  compile (loop       
         compile endloop >resolve H ;    
         immediate restrict              
: +LOOP  T 3 ?pairs  compile (+loop      
         compile endloop >resolve H ;    
         immediate restrict              
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\ predefinitions             bp27jun85we 
                                         
: abort"    T compile (abort" ," H ;     
 immediate                               
                                         
: error"    T compile (err"   ," H ;     
 immediate                               
                                         
                                         
                                         
                                         
Forth definitions                        
                                         
Variable torigin                         
Variable tudp       0 tudp !             
                                         
: >user  T c@ H torigin @ + ;            
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\ Datatypes                  bp27jun85we 
                                         
Transient definitions                    
                                         
: origin!  H torigin !  ;                
                                         
: user' ( - 8b)   T ' 2 + c@ H ;         
                                         
: uallot  ( n -) H tudp @ swap tudp +! ; 
                                         
                                         
        Do> >user ;                      
: User  prebuild User  2 T uallot c, ;   
                                         
           Do> ;                         
: Create   prebuild Create  ;            
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\ Datatypes                  bp27jun85we 
                                         
           Do> T @ H ;                   
: Constant prebuild Constant  T , ;      
                                         
: Variable Create 2 T allot ;            
                                         
                                         
 dummy                                   
: Vocabulary                             
 H >in @  Vocabulary  >in !              
 T prebuild Vocabulary  0 , 0 ,          
 here H tvoc-link @ T ,  H tvoc-link ! ; 
                                         
          Do>  ;                         
: Defer   prebuild Defer 2 T allot ;     
                                         
: Is  T ' H >body  State @               
   IF T compile (is  ,                   
 H ELSE T ! H THEN  ;   immediate        
                                         
                                         
                                         
                                         
                                        
\ target defining words      bp27jun85we 
                                         
| : dodoes>                              
 T compile (;code                        
 H Glast' @  there  resdoes>             
 there tdoes> ! ;                        
                                         
: ;code 0 T ?pairs dodoes>  Assembler    
 H [compile] [  redefinition ;           
 immediate restrict                      
                                         
: does>                                  
 T dodoes>                               
 $4C c, compile (dodoes> H ;             
 immediate restrict                      
                                         
 dummy                                   
: :  H  tdoes> off  >in @ >in: !         
 T prebuild : H current @ context !      
 T ] H 0 ;                               
                                         
                                         
                                         
                                         
                                        
\ :  Alias  ;                  02oct87re 
                                         
: Alias ( n -- )  H Tlast off            
 (theader  Ghost  over resolve           
 tlast @ T c@ H 20 or tlast @ T c! ,     
 H ;                                     
                                         
: ;  T 0 ?pairs                          
 compile unnest [compile] [              
 H redefinition  ;                       
 immediate  restrict                     
                                         
 dummy                                   
: Input:  H  tdoes> off  >in @ >in: !    
 T prebuild Input:                       
 H current @ context !  T ] H 0 ;        
                                         
 dummy                                   
: Output:  H  tdoes> off  >in @ >in: !   
 T prebuild Output:                      
 H current @ context !  T ] H 0 ;        
                                         
                                         
                                         
                                        
\ predefinitions             bp03jul85we 
                                         
: compile   T compile compile H ;        
            immediate  restrict          
                                         
: Host                                   
 H Onlyforth Ttools also ;               
                                         
: Compiler                               
 T Host H Transient also definitions ;   
                                         
: [compile] H Word, ; immediate restrict 
                                         
: Onlypatch H there 3 - 0 tdoes> ! 0 ;   
                                         
Onlyforth                                
                                         
: Target                                 
 Onlyforth Transient also definitions ;  
                                         
                                         
Transient definitions  Ghost c, drop     
                                         
                                         
                                        
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






\ Gebrauchsanweisung..        clv06dec88 
                                         
Target-Compiler ultraFORTH 3.8           
                                         
Achtung! Keine Weitergabe ohne           
         Erlaubnis. Der Targetcompiler   
         ist nicht (!!!) Public Domain.  
                                         
                                         
                                         
                                         
                                         
(c) volksFORTH-Autoren in der ForthGes.  
                                         
Rueckfragen an:                          
                                         
Georg Rehfeld  040 / 721 13 66           
  Reinbeker Weg 32, 2050 Hamburg 80      
                                         
Claus Vogt     030 / 216 89 38           
  Buelowstr.67,     1000 Berlin 30       
                                         
                                         
                                         
                                        
\ ..Gebrauchsanweisung..      clv05jan87 
                                         
1. Einleitung                            
   Der Targetcompiler ist seltsam,       
   kryptisch und gefaehrlich. Ich (clv)  
   habe ihn bisher nur als Black-Box     
   benutzt, d.h. wenn was schief geht    
   alles neu booten. Es soll auch        
   Leute geben, die ihn verstehen, aber  
   ich kenne sie leider nicht.           
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\ ..Gebrauchsanweisung..      clv06dec88 
                                         
2. Laden                                 
                                         
2.1. Relocate System                     
   Der auf dieser Diskette befindliche   
   Relocate-Screen erzeugt eine          
   Stacklen  $9400                       
   rStacklen $0400                       
                                         
   Limit musz $c000 sein, was beim       
   C64 sowieso der Fall ist, beim        
   C16 musz es runtergepatched werden    
2.1.a savesystem von 1of4 laden          
2.2. Editor laden (wenn gewuenscht)      
2.3. Targetcompiler laden (s.Loadscreen) 
     zunaechst nur den festen Teil       
2.4. savesystem ausfuehren               
2.5. Targetcompiler Predefinitions laden 
     (s.Loadscreen ganz unten)           
                                         
                                         
                                         
                                         
                                        
\ ..Gebrauchsanweisung..      clv06dec88 
                                         
2.6. Quelle laden                        
     Das Laden dauert ca. 1/2 Stunde     
     und gibt allerlei Meldungen.        
     - Hostrechner & Targetrechner       
       die Quelle gilt derzeit fuer      
       C16 & C64. Die entsprechenden     
       Definitionen von (C16 (C64 sind   
       ggf. zu aendern (s. Screen und    
       Handbuch)                         
     - Blk ## here #### there ####       
       werden als Statusbericht ausgeg.  
     - verschiedene <name> exists        
       Meldungen sind unkritisch         
     - am Ende wird ein SAVESYSTEM <name 
       ausgegeben. Wer dann einfach      
       <return> drueckt, ohne erst       
       die Diskette zu wechseln, ist     
       selber schuld.                    
                                         
                                         
                                         
                                         
                                        
\\ ..Gebr.Anw. Beispiel       clv06dec88 
                                         
3. Beispiel.                             
   So gemacht: clv06dec88 auf CBM Plus4  
                                         
   Benutzte Disketten:                   
   1of4 .. 4of4 - Lieferdisketten 3.8    
   TCq          - TargetComp Quelle      
   TCf          -     "     Files (leer) 
                                         
3.1. Erstellen eines Targetcompiler-     
     systems                             
                                         
   einschalten, 1of4 rein                
                                         
   DIRECTORY                             
   -> ...                                
                                         
   LOAD "C16ULTRAFORTH83",8              
   -> searching... loading...ready.      
                                         
   RUN                                   
   -> ultraFORTH ... ok                  
                                         
                                        
\\ ..Gebr.Anw. Beispiel       clv06dec88 
                                         
    TCq rein                             
    4 load flush  \ relocate             
    -> ultraFORTH83 ... ok               
                                         
    3of4 rein                            
    19 load flush \ Editor               
    -> blk 4 blk 5 ...... ok \ ca. 5 min 
                                         
    1of4 rein                            
    26 load flush \ savesystem           
                                         
    TCq rein                             
    $10 load flush \ TC-residenter Teil  
                                         
    TCf rein                             
    savesystem @:uf-tc-3.8               
    -> ok  Wenn Disk blinkt: Fehler      
    \ @: heiszt:ggf. File ueberschreiben 
    \ Dieses File kann spaeter den       
    \ bisherigen Prozesz ersetzen.       
                                         
                                         
                                        
\\ ..Gebr.Anw. Beispiel       clv06dec88 
3.2. Erstellen eines Systems             
     zuerst wie unter 3.1. verfahren     
     oder:                               
     LOAD "uf-tc-3.8",8                  
     -> searching...loading..ready.      
                                         
     RUN                                 
     -> ultraFORTH83 ... ok              
                                         
     TCq rein                            
     hex 27 30 thru flush                
        \ TC transienten Teil laden      
                                         
     2of4 rein                           
     $09 l \ ggf. edieren:               
             (c64 (c16 (c16+ (c16-       
             (hin)wegkommentieren        
             fuer Target-Maschine        
                                         
     f load \ System erstellen           
     TCf oder 1of4 oder sonstwas rein    
     save-target c16ultraforth83         
 bzw save-target c64ultraforth83         
- ENDE -                                
k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






\\    Begriffe:                          
Host      'normales' Forth-System im     
          Rechner                        
Target    System, in das compiliert wird 
Transient Vocabulary fuer T-Compilation  
          im Host                        
                                         
braucht Spezialassembler fuer Targetcode 
'normaler' Assembler                     
                                         
Startadresse des Target Systems im Host  
                                         
Tools fuer Target-System                 
Worte fuer Redefinitionen                
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\\                                       
                                         
Target-dp                                
here im Target                           
                                         
Startadresse des Target-Systems          
Wenn 0, werden Koepfe im Target erzeugt  
nfa des zuletzt erzeugten Wortes         
cfa des zuletzt erzeugten Ghosts         
cfa des Codes fuer Does>-Parts           
Adresse des letzten : im Block           
Tvoc-Link fuer Host                      
Tvoc-Link fuer Target                    
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\\                                       
                                         
schaltet auf RAM unter Betriebssystem    
                                         
                                         
schaltet zurueck                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
rechnet virtuelle Target-Adresse in      
physikalische Adresse um                 
                                         
cmove auf Heap mit automatischem hallot  
>image muss bei Aenderung der Verwaltung 
des virtuellen Memory fuer das Target-   
System beruecksichtigt werden.           
Ebenso c@ und c!                        
\\                                       
                                         
<forw> zeigt auf Code fuer Vorwaerts     
<res>  zeigt auf Code fuer resolved      
                                         
    falls compiling, wird Ghost unter(!) 
das letzte Context-Wort eingelinkt       
sonst normal an Current angehaengt       
lfa Ghost zeigt auf letztes Wort (s.o)   
holt Namen und prueft                    
            auf gueltige Laenge          
 verlaengert Namen um ein Blank          
ermittelt Namenslaenge ( len start link) 
cf.Ghost, cfa.Target, Ptr auf Does>.cfa  
6502-align                               
cmoved Ghost auf Heap                    
letztes Wort zeigt jetzt auf Ghost       
rechnet cfa.ghost aus                    
                                         
Last (Current @) wird erst durch reveal  
bei ; eingelinkt                         
                                         
                                         
                                         
                                        
\\                                       
                                         
sucht nach dem Ghost                     
                                         
                                         
                                         
sucht nach Ghost                         
wenn gefunden, fertig                    
wenn nicht gefunden, wird er angelegt    
                                         
kommat cfa.ghost ( <forw> oder <res> )   
                                         
                                         
Adr des Ptr auf Does>.cfa                
wenn vorhanden, cfa des Does> liefern    
sonst wird Ptr angelegt und s.o          
                                         
                                         
                                         
>heap startet auf geraden Adressen       
=> 6502-align                            
                                         
                                         
                                         
                                        
\\                                       
                                         
liefert cfa des Ghosts                   
                                         
                                         
gibt zu einem Ghost an, ob es            
eine Vorwaertsrefernz ist oder           
bereits aufgeloest (mit cfa.Target)      
                                         
dito fuer evtl. Does>-Parts              
                                         
                                         
                                         
                                         
                                         
                                         
                                         
waehrend Target-Compilation wird ' auf   
Ghosts angewendet                        
                                         
                                         
                                         
                                         
                                         
                                        
\\                                       
                                         
                                         
wenn cf =<forw>                          
und eine Adr im Target-System besteht    
verlasse unresolved? mit True-Flag       
                                         
                                         
prueft, ob name ein Ghost ist            
ermittelt cfa und prueft auf unresolved  
 desgl. mit Does>-Part                   
                                         
                                         
                                         
gibt fuer ein Vocabulary alle            
nicht-aufgeloesten Worte aus             
                                         
                                         
                                         
durch alle Vocabularys suche             
alle nicht-aufgeloesten Worte werden     
ausgegeben                               
                                         
                                         
                                        
\\                                       
                                         
Vocabulary structure:                    
Name           Bytes                     
Code           fuer Vocabularys          
Latest          0 1                      
Cold-Latest     2 3   normal             
Voc-link        4 5                      
-------------------                      
Tlatest         6 7   zusaetzlich        
Tvoc-link       8 9                      
                                         
                                         
T und H sind Immediate und ersetzen      
        damit [ Transient ]              
        bzw.  [ Forth ]  H => Host       
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\\  Worte fuer Target-Compilation        
                                         
Worte fuer virtuellen Target-Memory      
                                         
T c@ greift auf RAM unter Betriebssystem 
zu                                       
T c! ebenfalls.                          
Alle folgenden Worte benutzen c@ und c!  
                                         
                                         
                                         
                                         
cmove funktioniert nur von Host nach     
Target, nicht umgekehrt !                
                                         
                                         
                                         
                                         
                                         
                                         
Bei Aenderungen der virtuellen Speicher- 
verwaltung muessen c@, c! und >image     
geaendert werden!                        
                                         
                                        
\\  Worte fuer Target-Compilation        
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\\                                       
                                         
                                         
                                         
loest Vorwaertsreferenzen auf            
prueft, ob bereits aufgeloest ist        
ja, gib Warnmeldung aus                  
setze cfa.target auf neuen Wert, Ende    
Vorwaertsreferenz vorhanden ?            
ja, hole Adresse im Target               
 Abbruch, wenn sie auf sich selbst zeigt 
und setze cfa.target ein bis Ende        
cfa.target auf cfa.ghost und             
resolved als cf.target                   
                                         
dito fuer Does>-Parts                    
                                         
                                         
Does> compiliert einen JMP (dodoes>      
(dodoes> sorgt dafuer, dass die auf      
cfa.ghost folgende Adresse, naemlich     
cfa.target, auf den Stack kommt          
cfa.ghost ist entweder <forw> oder <res> 
cfa.target ist die cfa im Target-System  
ebenfalls <forw> oder bereits gueltig   
\\                                       
                                         
                                         
Durch alle Vocabluarys in Transient und  
Target setze Target-Cold-Latest          
auf Transient-Tlatest                    
                                         
Fehler, wenn Tvoc-link noch auf weitere  
Vocabularys zeigt                        
                                         
                                         
Zeigt auf Tlatest in Transient-Vocs      
                                         
                                         
                                         
                                         
speichert ein Targetsystem als Programm- 
file auf Diskette ab (C64-Special!!)     
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\\                                       
                                         
                                         
wenn 0, Kopf, sonst ?thead increment     
     6502-align und Ende                 
holt Namen und wandelt in Grosschrift    
Fehler bei falscher Laenge               
                                         
berechnet cfa und 6502-align             
Blocknummer fuer view                    
einlinken des neuen Namens in Current    
Tlast fuer immediate und restric anlegen 
Namen in Target eintragen                
                                         
                                         
             Tlast auf 0 setzen          
Header anlegen, Ghost anlegen, wenn neu, 
cfa.ghost nach Glast' und aufloesen      
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\\                                       
                                         
bei Create, User, Constant, Variable     
und Defer, nicht bei : und Vocabulary    
compiliert Ptr auf pfa.target in Host    
                                         
                                         
erzeugt Header in Host mit cfa.adr       
Diese zeigt auf einen Does>-Part im      
Target (s.u.)                            
                                         
von :                                    
wenn erzeugtes Wort in Current ausfuehr- 
bar sein soll, erzeuge einen Header      
mit entsprechender cfa                   
sonst nicht                              
lege einen Header in Target an und compi 
liere als cfa die des Does>-Parts        
trage dann diese Adresse in Host als     
pfa ein                                  
                                         
prebuild ist ein Defining-Word fuer      
Defining-Words !!                        
                                         
                                        
\\                                       
                                         
sorgt dafuer, dass die mit dem folgenden 
Defining-Word erzeugten Worte nicht aus- 
fuehrbar sind                            
Spezial-Does> fuer in Current angelegte  
Worte, uebergibt die pfa in Target !     
                                         
                                         
                                         
Do> ... ;  : ... Build ... ; entspricht  
Create ... Does>                         
                                         
: Do>     [compile] does> here 3 - 0 ] ; 
                                         
: (build  Create here 2- ! ;             
: Build  (cfa 0 - 0)                     
          0 ?pairs  [compile] Literal    
          compile (build 0 ;             
                                         
                                         
                                         
                                         
                                         
                                        
\\                                       
                                         
                                         
Assembler assembliert jetzt in Target    
                                         
                                         
                                         
                                         
schaltet Assembler ein und relocate      
                                         
                                         
                                         
Wenn label bereits als Ghost vorhanden   
  Vorwaertsreferenzen aufloesen          
als Constant in Host anlegen             
                                         
Label zeigt auf there                    
                                         
Special-Code fuer Target                 
                                         
                                         
                                         
                                         
                                         
                                        
\\                                       
Kontrollstrukturen fuer Target-System    
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
' in Transient greift auf Ghosts zu und  
liefert die cfa.target                   
                                         
Das folgende Wort wird ohne Kopf erzeugt 
                                         
wirkt auf Host, nicht auf Target         
                                         
                                        
\\     Tools fuer Target-System          
    entspricht den normalen Tools        
                                         
                                         
gibt n Zeichen ab adr aus                
                                         
                                         
gibt Namen des Wortes aus, wenn nfa <>0  
                                         
                                         
sonst ???                                
                                         
prueft, ob lfa nfa von cfa ist und       
liefert nfa zurueck, sonst cfa und ff    
                                         
                                         
                                         
                                         
wandelt cfa in nfa, wenn moeglich        
                                         
                                         
                                         
                                         
                                         
                                        
\\     Tools fuer Target-System          
    entspricht den normalen Tools        
                                         
                                         
                                         
                                         
druckt string ab adr und justiert adr    
                                         
                                         
                                         
                                         
gibt Namen des compilierten Wortes aus   
und justiert adr                         
                                         
                                         
gibt n Bytes ab adr aus und justiert adr 
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\\     Tools fuer Target-System          
    entspricht den normalen Tools        
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
gibt n Bytes ab adr aus, wie d, aber     
schoen geordnet                          
                                         
                                         
zeigt Quelltextscreen des entsprechenden 
Wortes                                   
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\\                                       
                                         
ermoeglicht die Ausfuehrung von neu er-  
zeugten Defining-Words waehrend der Tar- 
get-Compilation                          
tauchte ;code oder does> auf?            
 ja, Systemstatus retten                 
                                         
 >in auf Beginn der letzten Colondef.    
                                         
  noch nicht als Predefinition in        
  Transient vorhanden?                   
  ja, gib "Redefinition: " und letzten   
      Namen aus                          
  >in justieren, Forth-: aufrufen und    
  Definining als Context einschalten     
                                         
tdoes> zurecksetzen                      
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\\                                       
                                         
aendert die cfa des zuletzt definierten  
Wortes auf Does>-Part im Target          
                                         
                                         
compiliert eine Sequenz, die bei Aus-    
fuehrung die adr des Does>-Parts und     
(;code compiliert                        
                                         
;code und Does> muessen in redef neu     
definiert werden                         
entspricht Do> fuer prebuild             
traegt last word in Host ein und springt 
in redefinition hinter interpret zurueck 
                                         
Struktur eines im Host erzeugten Wortes: 
lfa|name|cfa auf jmp (doedoes|pfa auf    
Does>-Part in Target                     
                                         
Worte, die durch Redefinition von        
Defining Words erzeugt werden, liefern   
ihre PFA, wenn sie im Host ausgefuehrt   
werden                                   
                                        
\\                                       
                                         
Forth-Kontrollstrukturen, weil in        
Transient sonst die fuer Target gefunden 
wuerde                                   
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\\         Predefinitions                
Worte, die in Transient ausfuehrbar sein 
muessen                                  
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\\    Zentrale Compilerschleife          
                                         
                                         
                                         
                                         
                                         
suche Namen in Transient bzw. Forth      
gefunden, fuehre aus, wenn immediate     
   sonst setze >in zurueck               
suche Ghost und fuehre ggf. cfa aus      
                                         
Zahl? wenn ja, fuehre Literal aus (T!)   
                                         
                                         
                                         
erzeuge einen neuen Ghost und compiliere 
Vorweartsreferenz                        
                                         
                                         
                                         
Compiler einschalten setzt >interpret    
aus tcompile                             
                                         
                                         
                                        
\\ Conditionals fuer Target-Compilation  
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\\ Conditionals fuer Target-Compilation  
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\\                                       
                                         
Immediate-Words fuer Target              
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
origin in target                         
udp    in target                         
                                         
berechnet Adresse in User-Area aus       
Adresse des Offsets                      
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\\                                       
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
User-Variable sind auch in Transient     
ausfuehrbar und liefern Target-Adressen  
                                         
                                         
Mit Create erzeugte Worte sind in Tran-  
sient ausfuehrbar und liefern die        
pfa.target                               
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\\                                       
                                         
Auch Constant und Variable sind in Tran- 
sient ausfuehrbar und liefern die ent-   
sprechenden Target-Werte                 
                                         
                                         
                                         
                                         
Vocabularys sind in Transient ausfuehr-  
bar                                      
                                         
Vocabulary 'name' erzeugt:               
                                         
1. Einen Vocabulary-Eintrag in Current   
   mit 5 Feldern ueber tvoc verbunden    
2. Einen Vocabulary-Eintrag in Target    
   mit 3 Feldern ueber tvoc-link ver-    
   bunden                                
3. Einen Ghost                           
                                         
                                         
                                         
                                         
                                        
\\                                       
                                         
                                         
erzeugt einen Variablen-Header           
                                         
entspricht Is in Forth                   
                                         
                                         
                                         
erzeugt Code wie ;code in Forth          
                                         
Vorwaertsreferenz fuer Does>-Part wird   
aufgeloest und tdoes> fuer redefinition  
gesetzt                                  
wie ;code in Forth, jedoch redefinition  
wird vorbereitet                         
                                         
                                         
wie Does> in Forth, jedoch wird zusaetz- 
lich dodoes> ausgefuehrt                 
                                         
                                         
                                         
                                         
                                        
\\                                       
                                         
                                         
redefinition zunaechst abschalten        
 erzeugt keinen Eintrag in Transient     
 fuer mit : erzeugte Worte               
 setzt Context auf erstes feste Voc      
legt Header in Target an                 
und loest Vorwaerts-Referenzen mit       
Alias-cfa auf                            
entspricht hide in Forth                 
                                         
entspricht ; in Forth, zusaetzlich       
wird redefinition eingeleitet            
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
\\                                       
                                         
erzeugt compile als Vorwaertsreferenz !! 
                                         
                                         
setzt order auf:                         
Ttools Ttools Forth Only                 
                                         
wie Host, order:                         
Transient Transient Ttools Forth Only    
                                         
compiliert die cfa.target des Ghosts     
                                         
Spezial-Code fuer Only-Vocabulary        
                                         
                                         
setzt order fuer Target-Compilation:     
Transient Transient Forth Only           
                                         
Dank an Klaus fuer 'punctuation?' !!!    
                                         
                                         
                                         
                                         
                                        
                                         
                                         
erzeugt compile als Vorwaertsreferenz !! 
                                         
                                         
setzt Transient wieder auf normalen      
Vocabulary-Code, macht Target rueckgaen- 
gig                                      
Ttools sind fest in der Search-Order     
                                         
wie Host, Transient als Context          
                                         
                                         
compiliert die cfa.target des Ghosts     
                                         
Spezial-Code fuer Only-Vocabulary        
                                         
                                         
                                         
setzt Transient auf Only-Code Damit ist  
Transient letztes und unterstes Voc      
order: Transient Transient Transient     
                                         
                                         
Dank an Klaus fuer 'punctuation?' !!!   
                                         
                                         
erzeugt compile als Vorwaertsreferenz !! 
                                         
                                         
setzt Transient wieder auf normalen      
Vocabulary-Code, macht Target rueckgaen- 
gig                                      
Ttools sind fest in der Search-Order     
                                         
wie Host, Transient als Context          
                                         
                                         
compiliert die cfa.target des Ghosts     
                                         
Spezial-Code fuer Only-Vocabulary        
                                         
                                         
                                         
setzt Transient auf Only-Code Damit ist  
Transient letztes und unterstes Voc      
order: Transient Transient Transient     
                                         
                                         
Dank an Klaus fuer 'punctuation?' !!!   
                                         
                                         
erzeugt compile als Vorwaertsreferenz !! 
                                         
                                         
setzt Transient wieder auf normalen      
Vocabulary-Code, macht Target rueckgaen- 
gig                                      
Ttools sind fest in der Search-Order     
                                         
wie Host, Transient als Context          
                                         
                                         
compiliert die cfa.target des Ghosts     
                                         
Spezial-Code fuer Only-Vocabulary        
                                         
                                         
                                         
setzt Transient auf Only-Code Damit ist  
Transient letztes und unterstes Voc      
order: Transient Transient Transient     
                                         
                                         
Dank an Klaus fuer 'punctuation?' !!!   
k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






    TEST                             
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                         
                                        
k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






k





k





k





k






